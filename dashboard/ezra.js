class _A{constructor(){this.a={WORKER_URL:'https://auth-logs.universalezra.workers.dev/',RATE_LIMIT_WINDOW:300000,RATE_LIMIT_MAX_ATTEMPTS:5};this.b={scanLine:document.getElementById('scanLine'),status:document.getElementById('status'),btnContainer:document.getElementById('btnContainer'),loginForm:document.getElementById('loginForm'),fallbackBtn:document.getElementById('fallbackBtn'),visitBtn:document.getElementById('visitBtn'),webauthnBtn:document.getElementById('webauthnBtn'),emailInput:document.getElementById('email'),passwordInput:document.getElementById('password'),submitLogin:document.getElementById('submitLogin'),loadingSpinner:document.getElementById('loadingSpinner'),errorMsg:document.getElementById('errorMsg'),ipDisplay:document.getElementById('ipDisplay'),togglePassword:document.querySelector('.toggle-password'),webauthnUnsupported:document.getElementById('webauthnUnsupported'),ezraText:document.getElementById('ezraText'),container:document.querySelector('.container')};this.c={maxAttempts:3,blockDuration:300000,cookieName:'bioVAuthSecurity',loginStatusCookieName:'isEzraLoggedIn',loginCookieExpiryMinutes:10};this.d={webauthnSupported:!1,clientInfo:{}};this.i()}async i(){this.s();await this.g();this.j();this.k();this.e=new _S(this.c.maxAttempts,this.c.blockDuration,this.c.cookieName)}async g(){try{const t=new AbortController(),e=setTimeout(()=>t.abort(),3000),i=await fetch('https://api.ipify.org?format=json',{signal:t.signal});if(clearTimeout(e),!i.ok)throw new Error(`HTTP error! status: ${i.status}`);const s=await i.json();this.d.clientInfo={ip:s.ip,userAgent:navigator.userAgent,platform:navigator.platform,timestamp:(new Date).toISOString(),screenResolution:`${window.screen.width}x${window.screen.height}`,language:navigator.language};this.b.ipDisplay.textContent=`IP: ${s.ip} â€¢ ${navigator.platform}`}catch(t){console.error('Error collecting client info:',t),this.d.clientInfo={ip:'unavailable',userAgent:navigator.userAgent,platform:navigator.platform||'unknown',timestamp:(new Date).toISOString(),screenResolution:`${window.screen.width}x${window.screen.height}`,language:navigator.language||'unknown'},this.b.ipDisplay.textContent='Network: Secure â€¢ Private'}}s(){this.b.scanLine.style.opacity='1',this.u('Initializing security','info'),setTimeout(()=>{this.b.scanLine.style.opacity='0',this.u('System ready','success'),this.b.btnContainer.style.display='flex'},2e3)}u(t,e='info'){this.b.status.textContent=t,this.b.status.className='status',e&&this.b.status.classList.add(e)}j(){this.b.fallbackBtn.addEventListener('click',()=>this.l()),this.b.visitBtn.addEventListener('click',()=>window.location.href='https://universalezra.netlify.app'),this.b.webauthnBtn.addEventListener('click',()=>{this.d.webauthnSupported?this.w():this.b.webauthnUnsupported.style.display='block'}),this.b.loginForm.addEventListener('submit',async t=>{t.preventDefault(),await this.h()}),this.b.togglePassword.addEventListener('click',()=>this.p()),this.b.ezraText.addEventListener('click',()=>this.z())}k(){if(!window.PublicKeyCredential)return this.d.webauthnSupported=!1,this.b.webauthnBtn.disabled=!0,void(this.b.webauthnUnsupported.style.display='block');PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable().then(t=>{this.d.webauthnSupported=t,t||(this.b.webauthnUnsupported.style.display='block')}).catch(()=>{this.d.webauthnSupported=!1,this.b.webauthnUnsupported.style.display='block'})}l(){this.b.btnContainer.style.display='none',this.b.loginForm.style.display='block',this.b.emailInput.focus(),this.u(' Enter your credentials','info')}async h(){if(this.e.isBlocked()){this.m();return}const t=this.b.emailInput.value.trim().toLowerCase(),e=this.b.passwordInput.value;if(!t||!e){this.v('Please fill in all fields (username and password).');return}this.q(!0);try{const i=await fetch(this.a.WORKER_URL,{method:'POST',headers:{'Content-Type':'application/json','X-Client-IP':this.d.clientInfo.ip,'X-Client-UA':this.d.clientInfo.userAgent},body:JSON.stringify({username:t,password:e})}),s=await i.json();s.authenticated?this.n():this.o(s.message||'Invalid username or password')}catch(t){console.error('Login error: Try again',t),this.v('Login failed'),this.e.recordFailedAttempt()}finally{this.q(!1)}}n(){this.setCookie(this.c.loginStatusCookieName,'true',this.c.loginCookieExpiryMinutes),this.e.resetAttempts(),this.u('Authentication successful','success'),this.b.errorMsg.textContent='',window.location.href='secret.html'}o(t){this.e.recordFailedAttempt();const e=this.e.maxAttempts-this.e.attemptData.attempts;let i=t+(e>0?` (${e} ${1===e?'attempt':'attempts'} left)`:'');this.v(i),this.e.isBlocked()&&this.m(),this.b.passwordInput.value='',this.b.passwordInput.focus(),this.b.loginForm.classList.add('shake'),setTimeout(()=>this.b.loginForm.classList.remove('shake'),500)}m(){let t=this.e.getRemainingBlockTime();const e=()=>{const i=Math.floor(t/60),s=t%60;this.v(`Too many attempts. Wait ${i}m ${s}s.`)};this.q(!1),this.b.submitLogin.disabled=!0,e();const i=setInterval(()=>{if(t=this.e.getRemainingBlockTime(),t<=0)return clearInterval(i),this.b.errorMsg.textContent='',void(this.b.submitLogin.disabled=!1);e()},1e3)}v(t){this.b.errorMsg.textContent=t,this.b.errorMsg.style.display='block',setTimeout(()=>{this.b.errorMsg.textContent===t&&(this.b.errorMsg.style.display='none')},5e3)}q(t){this.b.submitLogin.disabled=t,this.b.loadingSpinner.style.display=t?'inline-block':'none',this.b.submitLogin.querySelector('.btn-text').textContent=t?'Authenticating':'Login'}p(){const t='password'===this.b.passwordInput.type;this.b.passwordInput.type=t?'text':'password',this.b.togglePassword.textContent=t?'ðŸ˜Œ':'ðŸ™‚',this.b.togglePassword.setAttribute('aria-label',t?'Hide password':'Show password')}async w(){if(!this.d.webauthnSupported){this.u('WebAuthn not supported','error');return}this.u('Mempersiapkan sensor biometrik','info');try{const t={challenge:new Uint8Array(32),rp:{name:"Universal Ezra Auth",id:window.location.hostname},user:{id:this.str2ab("user-dummy-id-"+Date.now()),name:"universalezra@example.com",displayName:"elviuser"},pubKeyCredParams:[{alg:-7,type:"public-key"}],timeout:6e4,authenticatorSelection:{authenticatorAttachment:"platform",requireResidentKey:!0,userVerification:"required"},attestation:"none"};this.u('Mohon pindai sidik jari Anda','info');const e=await navigator.credentials.create({publicKey:t});console.log('Kredensial berhasil dibuat:',e);const i=this.ab2b64url(e.rawId);this.u('Sidik Jari Terdeteksi','success'),setTimeout(()=>{this.u(`Credential ID: ...${i.substring(i.length-15)}`,'info')},1500)}catch(t){console.error("WebAuthn Error:",t),'NotAllowedError'===t.name?this.u('Proses dibatalkan oleh pengguna','error'):this.u('Gagal mendeteksi sidik jari','error')}}y(){const t=document.documentElement;document.fullscreenElement?(document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen&&document.msExitFullscreen(),this.u('Exiting fullscreen mode','info')):(t.requestFullscreen?t.requestFullscreen():t.mozRequestFullScreen?t.mozRequestFullScreen():t.webkitRequestFullscreen?t.webkitRequestFullscreen():t.msRequestFullscreen&&t.msRequestFullscreen(),this.u('Entering fullscreen mode','info'))}z(){this.y(),this.b.container.style.boxShadow='0 0 20px 5px var(--primary)',this.u('Sistem Ezra','success');const t=getComputedStyle(this.b.container).boxShadow;setTimeout(()=>{this.b.container.style.boxShadow=t,this.u('System ready','success')},3e3)}setCookie(t,e,i){const s=new Date;s.setTime(s.getTime()+60*i*1e3);const o="expires="+s.toUTCString();document.cookie=`${t}=${e};${o};path=/;SameSite=Strict;Secure`}getCookie(t){const e=t+"=";const i=document.cookie.split(';');for(let s=0;s<i.length;s++){let o=i[s];for(;" "===o.charAt(0);)o=o.substring(1,o.length);if(0===o.indexOf(e))return o.substring(e.length,o.length)}return null}str2ab(t){const e=new ArrayBuffer(t.length),i=new Uint8Array(e);for(let s=0,o=t.length;s<o;s++)i[s]=t.charCodeAt(s);return e}ab2b64url(t){return btoa(String.fromCharCode.apply(null,new Uint8Array(t))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'')}}class _S{constructor(t,e,i){this.maxAttempts=t,this.blockDuration=e,this.cookieName=i,this.attemptData=this.loadAttemptData()}loadAttemptData(){try{const t=this.getCookie(this.cookieName),e=t?JSON.parse(decodeURIComponent(t)):this.getDefaultData();return this.validateData(e)?e:this.getDefaultData()}catch(t){return console.error('Failed to parse security data',t),this.getDefaultData()}}getDefaultData(){return{attempts:0,lastAttempt:null,blockUntil:null}}validateData(t){return t&&'object'==typeof t&&'attempts'in t&&'lastAttempt'in t&&'blockUntil'in t}saveAttemptData(){const t=new Date;t.setDate(t.getDate()+1);const e=encodeURIComponent(JSON.stringify(this.attemptData));document.cookie=`${this.cookieName}=${e}; expires=${t.toUTCString()}; path=/; SameSite=Strict; Secure`}getCookie(t){return document.cookie.split(';').map(t=>t.trim()).find(e=>e.startsWith(t+'='))?.substring(t.length+1)}recordFailedAttempt(){const t=new Date;this.attemptData.attempts++,this.attemptData.lastAttempt=t.toISOString(),this.attemptData.attempts>=this.maxAttempts&&(this.attemptData.blockUntil=new Date(t.getTime()+this.blockDuration).toISOString()),this.saveAttemptData()}resetAttempts(){this.attemptData=this.getDefaultData(),this.saveAttemptData()}isBlocked(){if(!this.attemptData.blockUntil)return!1;const t=new Date(this.attemptData.blockUntil);return new Date>t?(this.resetAttempts(),!1):!0}getRemainingBlockTime(){if(!this.isBlocked())return 0;return Math.round((new Date(this.attemptData.blockUntil)-new Date)/1e3)}}document.addEventListener('DOMContentLoaded',()=>{new _A});
