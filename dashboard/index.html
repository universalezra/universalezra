<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --primary: #8e44ad; --accent: #00a8ff; --success: #2ecc71;
            --danger: #e74c3c; --light: #ecf0f1; --dark: #1a1a2e;
            --bg-main: #16213e; --bg-panel: rgba(26, 26, 46, 0.9);
            --text-primary: #e0fbfc; --text-secondary: #98ded9;
            --border-color: rgba(0, 168, 255, 0.3);
        }
        html[data-theme='light'] {
            --primary: #3498db; --accent: #e67e22;
            --bg-main: #ecf0f1; --bg-panel: rgba(255, 255, 255, 0.9);
            --text-primary: #2c3e50; --text-secondary: #7f8c8d;
            --border-color: rgba(52, 152, 219, 0.4);
        }
        * { box-sizing: border-box; }
        html, body {
            width: 100%; height: 100%; margin: 0; padding: 0;
            overflow: hidden; font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--bg-main); color: var(--text-primary);
        }
        #interactive-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0; background-color: var(--bg-main);
        }
        .main-container {
            position: relative; z-index: 1; width: 100%; height: 100%;
            transition: all 0.5s ease-in-out;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            padding: 20px;
        }
        .central-message {
            text-align: center;
            color: var(--text-primary);
            font-size: 1.5em;
        }
        .central-message h3 {
            color: var(--accent);
            margin-bottom: 10px;
        }
        .central-message p {
            color: var(--text-secondary);
            font-size: 0.8em;
        }

        .panel {
            position: fixed; background: var(--bg-panel); backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px); z-index: 1010;
            box-shadow: 0 0 50px rgba(0,0,0,0.6);
            transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            display: flex; flex-direction: column;
        }
        #editor-panel {
            top: 0; left: 0; width: 100%; height: 100%;
            transform: translateX(-100%);
        }
        #editor-panel.active { transform: translateX(0); }
        /* Music panel positioning - remains as bottom panel */
        #music-panel {
            bottom: 0; left: 0; width: 100%; height: auto;
            max-height: 50vh; border-top: 1px solid var(--border-color);
            transform: translateY(100%); padding: 15px;
        }
        #music-panel.active { transform: translateY(0); }
        #contribution-panel {
            top: 0; right: 0; width: 400px; max-width: 90vw; height: 100%;
            transform: translateX(100%); padding: 20px;
        }
        #contribution-panel.active { transform: translateX(0); }
        #live-visitors-panel, #backend-gallery-panel { /* Common styles for pop-up panels */
            top: 50%;
            left: 50%;
            width: 350px;
            max-width: 90vw;
            height: 60vh;
            transform: translate(-50%, -50%) scale(0.8);
            opacity: 0;
            pointer-events: none;
            border-radius: 15px;
            padding: 0;
            display: flex;
            flex-direction: column;
        }
        #live-visitors-panel.active, #backend-gallery-panel.active {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
            pointer-events: all;
        }
        .panel-close-btn {
            position: absolute; top: 15px; right: 15px; background: none; border: none;
            color: var(--text-primary); font-size: 1.5rem; cursor: pointer; z-index: 5;
        }
        .fab-container { position: fixed; z-index: 1000; }
        .fab {
            background: var(--primary); color: white; width: 55px; height: 55px;
            border-radius: 50%; border: none; cursor: pointer;
            display: flex; justify-content: center; align-items: center;
            font-size: 1.4rem; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }
        .fab:hover { background: var(--accent); transform: scale(1.1); }
        #fab-editor { top: 20px; left: 20px; }
        
        /* NEW POSITIONS FOR FABS */
        #fab-music { /* Moved to old private auth user spot */
            top: 50%;
            left: 20px;
            transform: translateY(-50%);
        }
        #fab-alkitab { /* New FAB for Alkitab, below music */
            top: calc(50% + 70px); /* Music FAB height (55px) + 15px gap */
            left: 20px;
            transform: translateY(-50%);
        }
        #fab-live-visitors { /* Moved to old music panel spot (bottom center) */
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
        }
        /* New FAB for Backend Gallery, position to be decided */
        #fab-backend-gallery {
            bottom: 20px; /* Aligned with Live Visitors */
            left: calc(50% - 70px); /* To the left of Live Visitors */
            transform: translateX(-50%);
        }
        #fab-contribution { top: 20px; right: 20px; } /* Remains same */


        /* EDITOR STYLES */
        #editor-panel { padding: 0; }
        .editor-toolbar {
            display: flex; gap: 5px; padding: 10px; background: rgba(0,0,0,0.2);
            flex-wrap: wrap; justify-content: flex-start;
        }
        .editor-toolbar button, .editor-toolbar select {
            background: var(--primary); color: white; border:none;
            padding: 8px 12px; border-radius: 5px; cursor: pointer;
        }
        .editor-toolbar button:hover, .editor-toolbar select:hover {
            background: var(--accent);
        }
        .editor-main { display: flex; flex-grow: 1; height: calc(100% - 58px); }
        .editor-code-area { flex: 1; display: flex; flex-direction: column; }
        .editor-preview-area { flex: 1; display: flex; flex-direction: column; }

        /* Single editor textarea */
        #unified-code-editor {
            flex-grow: 1; background: #1e1e1e; color: #f8f8f2; border: none;
            resize: none; padding: 10px; font-family: 'Courier New', monospace;
            font-size: 14px; outline: none; white-space: pre-wrap; word-wrap: break-word;
        }
        #editor-preview {
            width: 100%; height: 100%; border: none; background: white;
        }

        #video-player-widget {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 999;
            width: 150px;
            height: 150px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0,0,0,0.4);
            border: 2px solid var(--border-color);
        }
        #video-player-widget video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .video-controls {
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            background: rgba(0,0,0,0.5);
            padding: 5px;
            border-radius: 5px;
        }
        .video-controls button {
            background: none;
            border: none;
            color: white;
            font-size: 1rem;
            cursor: pointer;
        }
        .social-links { /* Only WhatsApp and Instagram now */
            position: fixed; top: 50%; right: 20px; transform: translateY(-50%);
            display: flex; flex-direction: column; gap: 15px; z-index: 999;
        }
        .social-links a { color: var(--text-primary); font-size: 1.5rem; transition: color 0.3s, transform 0.3s; }
        .social-links a:hover { color: var(--accent); transform: scale(1.2); }
        
        /* Desktop Layout specific styles - adjusted */
        body.desktop-layout .main-container {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 20px; padding: 20px; height: 100vh;
        }
        body.desktop-layout .panel {
            position: static; transform: none !important;
            height: auto; width: auto; max-height: none;
            box-shadow: 0 0 30px rgba(0,0,0,0.5); border: 1px solid var(--border-color);
            border-radius: 15px;
        }
        body.desktop-layout .panel-close-btn { display: none; }
        
        /* Ensure FABs and Social Links are always visible, not hidden by desktop layout */
        body.desktop-layout .fab-container, body.desktop-layout .social-links {
            display: block; /* Override any desktop-layout specific hiding */
        }
        body.desktop-layout .fab {
            /* Keep desktop fabs as floating buttons */
        }

        #visitor-list li, .gallery-item {
            background: rgba(0, 168, 255, 0.1);
            border: 1px solid rgba(0, 168, 255, 0.2);
            border-radius: 8px;
            margin-bottom: 10px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            font-size: 0.9em;
            color: var(--text-primary);
        }
        #visitor-list li strong, .gallery-item strong {
            color: var(--accent);
        }
        #visitor-list li span, .gallery-item span {
            word-break: break-all;
        }
        .gallery-item img, .gallery-item video, .gallery-item audio {
            max-width: 100%; height: auto; border-radius: 5px; margin-top: 5px;
        }
        .gallery-item .media-container {
            position: relative;
            width: 100%;
            height: 150px; /* Fixed height for small items */
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: rgba(0,0,0,0.1);
            border-radius: 5px;
            margin-top: 5px;
        }
        .gallery-item .media-container img,
        .gallery-item .media-container video,
        .gallery-item .media-container audio {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain; /* Fit without cropping */
            display: block;
        }
    </style>
</head>
<body class=""> <canvas id="interactive-bg"></canvas>
    <div class="main-container">
        <div class="central-message">
            <h3>Selamat Datang!</h3>
            <p>Ini adalah website Anda. Anda bisa mengeditnya menggunakan Code Editor.</p>
        </div>
        <div class="panel" id="contribution-panel-desktop" style="display: none;">
             </div>
    </div>
    <div class="panel" id="editor-panel">
        <button class="panel-close-btn" data-panel="editor-panel"><i class="fas fa-times"></i></button>
        <div class="editor-toolbar">
            <button id="editor-run"><i class="fas fa-play"></i> Run</button>
            <button id="editor-save"><i class="fas fa-save"></i> Save</button>
            <button id="editor-load"><i class="fas fa-folder-open"></i> Load</button>
            <button id="editor-new"><i class="fas fa-file"></i> New</button>
            <button id="editor-undo"><i class="fas fa-undo"></i> Undo</button>
            <button id="editor-redo"><i class="fas fa-redo"></i> Redo</button>
        </div>
        <div class="editor-main">
            <div class="editor-code-area">
                <textarea id="unified-code-editor" spellcheck="false"></textarea>
            </div>
            <div class="editor-preview-area">
                 <iframe id="editor-preview"></iframe>
            </div>
        </div>
    </div>
    <div class="panel" id="music-panel">
        <button class="panel-close-btn" data-panel="music-panel"><i class="fas fa-times"></i></button>
        <h4>Now Playing</h4>
        <div id="music-player-content">
            <h5 id="song-title">Select a song</h5>
            <audio id="audio-player" controls loop style="width: 100%;"></audio>
            <div id="playlist" style="max-height: 20vh; overflow-y: auto; margin-top: 10px;"></div>
        </div>
    </div>
    <div class="panel" id="contribution-panel">
        <button class="panel-close-btn" data-panel="contribution-panel"><i class="fas fa-times"></i></button>
        <div id="contribution-content" style="display: flex; flex-direction: column; height: 100%;">
            <h3 style="margin-top:20px;">Leave a Message</h3>
            <div id="contribution-display" style="flex-grow: 1; overflow-y: auto; padding-right: 10px; margin-bottom: 15px;">
                <p>Loading messages...</p>
            </div>
            <form id="contribution-form">
                <textarea id="contribution-text" placeholder="Your message..." required style="width:100%; min-height: 80px; background:rgba(0,0,0,0.2); color:var(--text-primary); border:1px solid var(--border-color); border-radius:5px; padding:10px;"></textarea>
                <div style="display:flex; justify-content:flex-end; align-items:center; margin-top:10px;">
                    <button type="submit" class="fab" style="position:static; width:45px; height:45px; font-size:1.1rem;"><i class="fas fa-paper-plane"></i></button>
                </div>
                <p id="contribution-status" style="font-size:0.9em; text-align:center; margin-top:10px;"></p>
            </form>
        </div>
    </div>
    <div class="fab-container" id="fab-live-visitors" style="display: none;"> <button class="fab" data-panel="live-visitors-panel" title="Live Visitors"><i class="fas fa-eye"></i></button>
    </div>
    <div class="panel" id="live-visitors-panel">
        <button class="panel-close-btn" data-panel="live-visitors-panel"><i class="fas fa-times"></i></button>
        <div style="padding: 20px; height: 100%; display: flex; flex-direction: column;">
            <h3 style="margin-bottom: 15px; color: var(--accent); text-align: center;">Live Visitors</h3>
            <div id="visitor-list-container" style="flex-grow: 1; overflow-y: auto; padding-right: 10px;">
                <p style="text-align: center; color: var(--text-secondary);">Loading visitors...</p>
                <ul id="visitor-list" style="list-style: none; padding: 0; margin: 0;">
                </ul>
            </div>
            <div style="margin-top: 15px; text-align: center; font-size: 0.85em; color: var(--text-secondary);">
                Last updated: <span id="last-updated-time">N/A</span>
            </div>
        </div>
    </div>

    <div class="fab-container" id="fab-backend-gallery" style="display: none;"> <button class="fab" data-panel="backend-gallery-panel" title="My Moments"><i class="fas fa-images"></i></button>
    </div>
    <div class="panel" id="backend-gallery-panel">
        <button class="panel-close-btn" data-panel="backend-gallery-panel"><i class="fas fa-times"></i></button>
        <div style="padding: 20px; height: 100%; display: flex; flex-direction: column;">
            <h3 style="margin-bottom: 15px; color: var(--accent); text-align: center;">My Life Moments Gallery</h3>
            <div id="gallery-upload-form" style="margin-bottom: 20px; padding: 10px; border: 1px dashed var(--border-color); border-radius: 8px;">
                <h4>Upload New Moment</h4>
                <input type="text" id="gallery-description" placeholder="Description" style="width:100%; padding:8px; margin-bottom:10px; background:rgba(0,0,0,0.1); border:1px solid var(--border-color); color:var(--text-primary); border-radius:4px;">
                <input type="file" id="gallery-file-input" accept="image/*,video/*,audio/*,application/pdf" style="width:100%; color:var(--text-secondary); margin-bottom:10px;">
                <button id="gallery-upload-btn" class="fab" style="position:static; width:100px; height:40px; font-size:1rem;"><i class="fas fa-upload"></i> Upload</button>
                <p id="gallery-upload-status" style="font-size:0.9em; text-align:center; margin-top:10px;"></p>
            </div>
            <div id="gallery-items-container" style="flex-grow: 1; overflow-y: auto; padding-right: 10px;">
                <p style="text-align: center; color: var(--text-secondary);">Loading moments...</p>
                <div id="gallery-items" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px;">
                    </div>
            </div>
        </div>
    </div>


    <div class="fab-container" id="fab-editor">
        <button class="fab" data-panel="editor-panel" title="Code Editor"><i class="fas fa-code"></i></button>
    </div>
    <div class="fab-container" id="fab-music">
        <button class="fab" data-panel="music-panel" title="Music Player"><i class="fas fa-music"></i></button>
    </div>
    <div class="fab-container" id="fab-alkitab"> <a href="https://alkitab.me/in-tb/Matius/5/13" target="_blank" class="fab" title="Alkitab"><i class="fas fa-book"></i></a>
    </div>
    <div class="fab-container" id="fab-contribution">
        <button class="fab" data-panel="contribution-panel" title="Leave a Message"><i class="fas fa-feather-alt"></i></button>
    </div>
    <div id="video-player-widget">
        <video id="widget-video" loop src="video.mp4"></video>
        <div class="video-controls">
            <button id="video-play-pause"><i class="fas fa-play"></i></button>
            <button id="video-mute"><i class="fas fa-volume-up"></i></button>
        </div>
    </div>
    <div class="social-links"> <a href="https://wa.me/6283844959380" target="_blank" title="WhatsApp"><i class="fab fa-whatsapp"></i></a>
        <a href="https://instagram.com/I_dont_care_now" target="_blank" title="Instagram"><i class="fab fa-instagram"></i></a>
        </div>
<script>
const CONTRIBUTIONS_WORKER_URL = 'https://contributions-workerjs.ezvvel.workers.dev/';
const LIVE_VISITORS_WORKER_URL = 'https://live-visitors.ezvvel.workers.dev/';
// New Worker URL for Gallery (replace with your deployed worker URL)
const GALLERY_WORKER_URL = 'YOUR_GALLERY_WORKER_URL_HERE'; 

const REFRESH_INTERVAL_MS = 5000;
let visitorRefreshInterval;

// BioVAuth Classes - START
// (Paste your BioVAuth and SecuritySystem classes here)
class BioVAuth{constructor(){this.env={WORKER_URL:'https://auth-logs.ezvvel.workers.dev/',RATE_LIMIT_WINDOW:300000,RATE_LIMIT_MAX_ATTEMPTS:5};this.elements={scanLine:document.getElementById('scanLine'),status:document.getElementById('status'),btnContainer:document.getElementById('btnContainer'),loginForm:document.getElementById('loginForm'),fallbackBtn:document.getElementById('fallbackBtn'),visitBtn:document.getElementById('visitBtn'),webauthnBtn:document.getElementById('webauthnBtn'),emailInput:document.getElementById('email'),passwordInput:document.getElementById('password'),submitLogin:document.getElementById('submitLogin'),loadingSpinner:document.getElementById('loadingSpinner'),errorMsg:document.getElementById('errorMsg'),ipDisplay:document.getElementById('ipDisplay'),togglePassword:document.querySelector('.toggle-password'),webauthnUnsupported:document.getElementById('webauthnUnsupported')};this.securityConfig={maxAttempts:3,blockDuration:300000,cookieName:'bioVAuthSecurity',localStorageKey:'isEzraLoggedIn'};this.state={webauthnSupported:false,clientInfo:{}};this.init();}async init(){this.startBiometricAnimation();await this.collectClientInfo();this.setupEventListeners();this.checkWebAuthnSupport();this.securitySystem=new SecuritySystem(this.securityConfig.maxAttempts,this.securityConfig.blockDuration,this.securityConfig.cookieName);}async collectClientInfo(){try{const controller=new AbortController();const id=setTimeout(()=>controller.abort(),3000);const ipResponse=await fetch('https://api.ipify.org?format=json',{signal:controller.signal});clearTimeout(id);if(!ipResponse.ok)throw new Error(`HTTP error! status: ${ipResponse.status}`);const ipData=await ipResponse.json();this.state.clientInfo={ip:ipData.ip,userAgent:navigator.userAgent,platform:navigator.platform,timestamp:new Date().toISOString(),screenResolution:`${window.screen.width}x${window.screen.height}`,language:navigator.language};this.elements.ipDisplay.textContent=`IP: ${ipData.ip} â€¢ ${navigator.platform}`;}catch(error){console.error('Error collecting client info:',error);this.state.clientInfo={ip:'unavailable',userAgent:navigator.userAgent,platform:navigator.platform||'unknown',timestamp:new Date().toISOString(),screenResolution:`${window.screen.width}x${window.screen.height}`,language:navigator.language||'unknown'};this.elements.ipDisplay.textContent='Network: Secure â€¢ Private';}}startBiometricAnimation(){this.elements.scanLine.style.opacity='1';this.updateStatus('Initializing security protocols','info');setTimeout(()=>{this.elements.scanLine.style.opacity='0';this.updateStatus('System ready','success');this.elements.btnContainer.style.display='flex';},2000);}updateStatus(message,type='info'){this.elements.status.textContent=message;this.elements.status.className='status';if(type)this.elements.status.classList.add(type);}setupEventListeners(){this.elements.fallbackBtn.addEventListener('click',()=>this.showLoginForm());this.elements.visitBtn.addEventListener('click',()=>window.location.href='dashboard');this.elements.webauthnBtn.addEventListener('click',()=>{if(this.state.webauthnSupported)this.initiateWebAuthn();else this.elements.webauthnUnsupported.style.display='block';});this.elements.loginForm.addEventListener('submit',async(e)=>{e.preventDefault();await this.handleLogin();});this.elements.togglePassword.addEventListener('click',()=>this.togglePasswordVisibility());}checkWebAuthnSupport(){if(!window.PublicKeyCredential){this.state.webauthnSupported=false;this.elements.webauthnBtn.disabled=true;this.elements.webauthnUnsupported.style.display='block';return;}PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable().then(available=>{this.state.webauthnSupported=available;if(!available)this.elements.webauthnUnsupported.style.display='block';}).catch(()=>{this.state.webauthnSupported=false;this.elements.webauthnUnsupported.style.display='block';});}showLoginForm(){this.elements.btnContainer.style.display='none';this.elements.loginForm.style.display='block';this.elements.emailInput.focus();this.updateStatus('Enter your credentials','info');}async handleLogin(){if(this.securitySystem.isBlocked()){this.showBlockedMessage();return;}const username=this.elements.emailInput.value.trim().toLowerCase();const password=this.elements.passwordInput.value;if(!username||!password){this.showError('Please fill in all fields (username and password).');return;}this.setLoadingState(true);try{const response=await fetch(this.env.WORKER_URL,{method:'POST',headers:{'Content-Type':'application/json','X-Client-IP':this.state.clientInfo.ip,'X-Client-UA':this.state.clientInfo.userAgent},body:JSON.stringify({username,password})});const responseData=await response.json();if(responseData.authenticated){localStorage.setItem(this.securityConfig.localStorageKey,'true');this.securitySystem.resetAttempts();this.updateStatus('Authentication successful! Redirecting...','success');window.location.href='dashboard';}else{this.handleFailedLogin(responseData.message||'Invalid username or password.');}}catch(error){console.error('Login error (network or worker response parsing issue):',error);this.showError('Login failed: network issue or server error. Please try again.');this.securitySystem.recordFailedAttempt();}finally{this.setLoadingState(false);}}handleSuccessfulLogin(){localStorage.setItem(this.securityConfig.localStorageKey,'true');this.securitySystem.resetAttempts();this.updateStatus('Authentication successful!','success');this.elements.errorMsg.textContent='';window.location.href='dashboard';}handleFailedLogin(errorMessage){this.securitySystem.recordFailedAttempt();const attemptsLeft=this.securitySystem.maxAttempts-this.securitySystem.attemptData.attempts;let displayMessage=errorMessage+(attemptsLeft>0?` (${attemptsLeft} ${attemptsLeft===1?'attempt':'attempts'} left)`:'');this.showError(displayMessage);if(this.securitySystem.isBlocked())this.showBlockedMessage();this.elements.passwordInput.value='';this.elements.passwordInput.focus();this.elements.loginForm.classList.add('shake');setTimeout(()=>this.elements.loginForm.classList.remove('shake'),500);}showBlockedMessage(){let remainingTime=this.securitySystem.getRemainingBlockTime();const updateCountdown=()=>{const minutes=Math.floor(remainingTime/60);const seconds=remainingTime%60;this.showError(`Too many attempts. Please wait ${minutes}m ${seconds}s.`);};this.setLoadingState(false);this.elements.submitLogin.disabled=true;updateCountdown();const countdownInterval=setInterval(()=>{remainingTime=this.securitySystem.getRemainingBlockTime();if(remainingTime<=0){clearInterval(countdownInterval);this.elements.errorMsg.textContent='';this.elements.submitLogin.disabled=false;return;}updateCountdown();},1000);}showError(message){this.elements.errorMsg.textContent=message;this.elements.errorMsg.style.display='block';setTimeout(()=>{if(this.elements.errorMsg.textContent===message)this.elements.errorMsg.style.display='none';},5000);}setLoadingState(isLoading){this.elements.submitLogin.disabled=isLoading;this.elements.loadingSpinner.style.display=isLoading?'inline-block':'none';this.elements.submitLogin.querySelector('.btn-text').textContent=isLoading?'Authenticating...':'Login';}togglePasswordVisibility(){const isPassword=this.elements.passwordInput.type==='password';this.elements.passwordInput.type=isPassword?'text':'password';this.elements.togglePassword.textContent=isPassword?'ðŸ˜Œ':'ðŸ™‚';this.elements.togglePassword.setAttribute('aria-label',isPassword?'Hide password':'Show password');}initiateWebAuthn(){if(!this.state.webauthnSupported)return;this.updateStatus('Initiating biometric authentication...','info');setTimeout(()=>this.updateStatus('Please use your device biometric authenticator','info'),1000);}}class SecuritySystem{constructor(maxAttempts,blockDuration,cookieName){this.maxAttempts=maxAttempts;this.blockDuration=blockDuration;this.cookieName=cookieName;this.attemptData=this.loadAttemptData();}loadAttemptData(){try{const cookieData=this.getCookie(this.cookieName);const data=cookieData?JSON.parse(decodeURIComponent(cookieData)):this.getDefaultData();return this.validateData(data)?data:this.getDefaultData();}catch(e){console.error('Failed to parse cookie data:',e);return this.getDefaultData();}}getDefaultData(){return{attempts:0,lastAttempt:null,blockUntil:null};}validateData(data){return data&&typeof data==='object'&&'attempts'in data&&'lastAttempt'in data&&'blockUntil'in data;}saveAttemptData(){const expires=new Date();expires.setDate(expires.getDate()+1);const data=encodeURIComponent(JSON.stringify(this.attemptData));document.cookie=`${this.cookieName}=${data}; expires=${expires.toUTCString()}; path=/; SameSite=Strict; Secure`;}getCookie(name){return document.cookie.split(';').map(c=>c.trim()).find(c=>c.startsWith(name+'='))?.substring(name.length+1);}recordFailedAttempt(){const now=new Date();this.attemptData.attempts++;this.attemptData.lastAttempt=now.toISOString();if(this.attemptData.attempts>=this.maxAttempts){this.attemptData.blockUntil=new Date(now.getTime()+this.blockDuration).toISOString();}this.saveAttemptData();}resetAttempts(){this.attemptData=this.getDefaultData();this.saveAttemptData();}isBlocked(){if(!this.attemptData.blockUntil)return false;const blockUntil=new Date(this.attemptData.blockUntil);const now=new Date();if(now>blockUntil){this.resetAttempts();return false;}return true;}getRemainingBlockTime(){if(!this.isBlocked())return 0;return Math.round((new Date(this.attemptData.blockUntil)-new Date())/1000);}}
// BioVAuth Classes - END


document.addEventListener('DOMContentLoaded', () => {
    initParticleBackground();
    initPanelControls();
    initVideoPlayer();
    initEditor();
    initMusicPlayer();
    trackVisitor();
    new BioVAuth(); // Initialize BioVAuth to manage isEzraLoggedIn state

    // Read isEzraLoggedIn state from localStorage managed by BioVAuth
    const isEzraLoggedIn = localStorage.getItem('isEzraLoggedIn') === 'true';
    checkEzraLoginAndShowVisitorsButton(isEzraLoggedIn); // Pass state
    checkEzraLoginAndShowBackendGalleryButton(isEzraLoggedIn); // Pass state
});

function initPanelControls() {
    document.querySelectorAll('[data-panel]').forEach(button => {
        button.addEventListener('click', () => {
            const panelId = button.getAttribute('data-panel');
            const panel = document.getElementById(panelId);

            panel.classList.toggle('active');

            if (panelId === 'live-visitors-panel') {
                if (panel.classList.contains('active')) {
                    fetchLiveVisitors();
                    visitorRefreshInterval = setInterval(fetchLiveVisitors, REFRESH_INTERVAL_MS);
                } else {
                    clearInterval(visitorRefreshInterval);
                    const visitorList = document.getElementById('visitor-list');
                    visitorList.innerHTML = '';
                }
            } else if (panelId === 'backend-gallery-panel') {
                 if (panel.classList.contains('active')) {
                    fetchGalleryContent(); // Load gallery content when opened
                 }
            }
            
            if (panelId === 'contribution-panel' && panel.classList.contains('active')) {
                fetchContributions();
            }

            // Close other panels (except for contribution panel if backend-gallery is opened)
            document.querySelectorAll('.panel').forEach(otherPanel => {
                if (otherPanel.id !== panelId) {
                    otherPanel.classList.remove('active');
                    if (otherPanel.id === 'live-visitors-panel') {
                        clearInterval(visitorRefreshInterval);
                        document.getElementById('visitor-list').innerHTML = '';
                    }
                }
            });
        });
    });

    document.querySelectorAll('.panel-close-btn').forEach(button => {
        button.addEventListener('click', () => {
            const panelId = button.getAttribute('data-panel');
            const panel = document.getElementById(panelId);
            panel.classList.remove('active');
            if (panelId === 'live-visitors-panel') { // Clear interval if live visitors panel is closed
                clearInterval(visitorRefreshInterval);
                const visitorList = document.getElementById('visitor-list');
                visitorList.innerHTML = '';
            }
        });
    });
}

function checkEzraLoginAndShowVisitorsButton(isLoggedIn) {
    const fabLiveVisitors = document.getElementById('fab-live-visitors');
    if (isLoggedIn) {
        fabLiveVisitors.style.display = 'flex';
    } else {
        fabLiveVisitors.style.display = 'none';
    }
}

function checkEzraLoginAndShowBackendGalleryButton(isLoggedIn) {
    const fabBackendGallery = document.getElementById('fab-backend-gallery');
    if (isLoggedIn) {
        fabBackendGallery.style.display = 'flex';
    } else {
        fabBackendGallery.style.display = 'none';
    }
}

function initParticleBackground() {
    const canvas = document.getElementById('interactive-bg');
    const ctx = canvas.getContext('2d');
    let particles = [];
    let mouse = { x: null, y: null, radius: 150 };
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    window.addEventListener('resize', () => {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    });
    window.addEventListener('mousemove', (event) => {
        mouse.x = event.x;
        mouse.y = event.y;
    });
    class Particle {
        constructor(x, y, dirX, dirY, size, color) {
            this.x = x; this.y = y; this.dirX = dirX; this.dirY = dirY;
            this.size = size; this.color = color;
        }
        draw() {
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2, false);
            ctx.fillStyle = this.color;
            ctx.fill();
        }
        update() {
            if (this.x > canvas.width || this.x < 0) this.dirX = -this.dirX;
            if (this.y > canvas.height || this.y < 0) this.dirY = -this.dirY;
            this.x += this.dirX;
            this.y += this.dirY;
            this.draw();
        }
    }
    function initParticles() {
        particles = [];
        let numParticles = (canvas.height * canvas.width) / 9000;
        for (let i = 0; i < numParticles; i++) {
            let size = Math.random() * 2 + 1;
            let x = Math.random() * (innerWidth - size * 2);
            let y = Math.random() * (innerHeight - size * 2);
            let dirX = (Math.random() * .4) - .2;
            let dirY = (Math.random() * .4) - .2;
            let color = 'rgba(0, 168, 255, 0.8)';
            particles.push(new Particle(x, y, dirX, dirY, size, color));
        }
    }
    function connectParticles() {
        for (let a = 0; a < particles.length; a++) {
            for (let b = a; b < particles.length; b++) {
                let distance = ((particles[a].x - particles[b].x) * (particles[a].x - particles[b].x))
                             + ((particles[a].y - particles[b].y) * (particles[a].y - particles[b].y));
                if (distance < (canvas.width / 7) * (canvas.height / 7)) {
                    let opacity = 1 - (distance / 20000);
                    ctx.strokeStyle = `rgba(0, 168, 255, ${opacity})`;
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.moveTo(particles[a].x, particles[a].y);
                    ctx.lineTo(particles[b].x, particles[b].y);
                    ctx.stroke();
                }
            }
        }
    }
    function animateParticles() {
        requestAnimationFrame(animateParticles);
        ctx.clearRect(0, 0, innerWidth, innerHeight);
        particles.forEach(p => p.update());
        connectParticles();
    }
    initParticles();
    animateParticles();
}


function initVideoPlayer() {
    const video = document.getElementById('widget-video');
    const playBtn = document.getElementById('video-play-pause');
    const muteBtn = document.getElementById('video-mute');

    playBtn.addEventListener('click', () => {
        if (video.paused) {
            video.play();
            playBtn.innerHTML = '<i class="fas fa-pause"></i>';
        } else {
            video.pause();
            playBtn.innerHTML = '<i class="fas fa-play"></i>';
        }
    });
    muteBtn.addEventListener('click', () => {
        video.muted = !video.muted;
        muteBtn.innerHTML = video.muted ? '<i class="fas fa-volume-mute"></i>' : '<i class="fas fa-volume-up"></i>';
    });
}

function initMusicPlayer() {
    const player = document.getElementById('audio-player');
    const playlistEl = document.getElementById('playlist');
    const songTitleEl = document.getElementById('song-title');
    const songs = [
        { name: "Where We Are", url: "where-we-are.mp3" },
        { name: "Wish You Were Here", url: "wish-you-were-here.mp3" },
        { name: "ghost to you", url: "ghost-to-you.mp3" },
    ];
    songs.forEach((song, index) => {
        const item = document.createElement('div');
        item.textContent = song.name;
        item.style.cursor = 'pointer';
        item.style.padding = '8px';
        item.onclick = () => {
            player.src = song.url;
            songTitleEl.textContent = song.name;
            player.play();
        };
        playlistEl.appendChild(item);
    });
}

function initEditor() {
    const codeEditor = document.getElementById('unified-code-editor');
    const previewFrame = document.getElementById('editor-preview');
    const runBtn = document.getElementById('editor-run');
    const saveBtn = document.getElementById('editor-save');
    const loadBtn = document.getElementById('editor-load');
    const newBtn = document.getElementById('editor-new');
    const undoBtn = document.getElementById('editor-undo');
    const redoBtn = document.getElementById('editor-redo');

    // History stack for Undo/Redo
    let history = ['']; // Initial empty state
    let historyPointer = 0;

    const updateHistory = () => {
        const currentCode = codeEditor.value;
        if (currentCode !== history[historyPointer]) {
            // If pointer is not at the end, clear future history
            if (historyPointer < history.length - 1) {
                history = history.slice(0, historyPointer + 1);
            }
            history.push(currentCode);
            historyPointer = history.length - 1;
        }
    };

    const runCode = () => {
        const fullCode = codeEditor.value;
        
        // Extract HTML, CSS, and JS using simple regex (can be improved for robustness)
        const htmlMatch = fullCode.match(/<body>([\s\S]*?)<\/body>/i);
        const cssMatch = fullCode.match(/<style>([\s\S]*?)<\/style>/i);
        const jsMatch = fullCode.match(/<script>([\s\S]*?)<\/script>/i);

        const htmlContent = htmlMatch ? htmlMatch[1] : fullCode; // If no body tag, assume it's pure HTML or the whole thing
        const cssContent = cssMatch ? cssMatch[1] : '';
        const jsContent = jsMatch ? jsMatch[1] : '';

        const source = `
            <!DOCTYPE html>
            <html>
                <head>
                    <style>${cssContent}</style>
                </head>
                <body>
                    ${htmlContent}
                    <script>${jsContent}<\/script>
                </body>
            </html>
        `;
        previewFrame.srcdoc = source;
    };

    const saveCode = () => {
        localStorage.setItem('unified_editor_code', codeEditor.value);
        alert('Code saved successfully!');
    };

    const loadCode = () => {
        codeEditor.value = localStorage.getItem('unified_editor_code') || `
<!DOCTYPE html>
<html>
<head>
    <title>My Page</title>
    <style>
        body {
            font-family: sans-serif;
            background-color: #f0f0f0;
            color: #333;
            text-align: center;
            padding-top: 50px;
        }
        h1 {
            color: var(--primary);
        }
    </style>
</head>
<body>
    <h1>Hello from Unified Editor!</h1>
    <p id="message">This is a paragraph.</p>

    <script>
        document.getElementById('message').onclick = function() {
            alert('Paragraph clicked!');
        };
    <\/script>
</body>
</html>
        `;
        runCode(); // Run immediately after loading
        history = [codeEditor.value]; // Reset history
        historyPointer = 0;
    };

    const newDoc = () => {
        codeEditor.value = `
<!DOCTYPE html>
<html>
<head>
    <title>New Page</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #282c34;
            color: #abb2bf;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }
        h1 {
            color: #61dafb;
        }
    </style>
</head>
<body>
    <h1>Start Coding Here!</h1>
    <script>
        // Your JavaScript goes here
        console.log("New document loaded.");
    <\/script>
</body>
</html>
        `;
        runCode();
        history = [codeEditor.value]; // Reset history
        historyPointer = 0;
    };

    const undo = () => {
        if (historyPointer > 0) {
            historyPointer--;
            codeEditor.value = history[historyPointer];
            runCode();
        }
    };

    const redo = () => {
        if (historyPointer < history.length - 1) {
            historyPointer++;
            codeEditor.value = history[historyPointer];
            runCode();
        }
    };

    runBtn.addEventListener('click', runCode);
    saveBtn.addEventListener('click', saveCode);
    loadBtn.addEventListener('click', loadCode);
    newBtn.addEventListener('click', newDoc);
    undoBtn.addEventListener('click', undo);
    redoBtn.addEventListener('click', redo);

    // Update history on every input
    codeEditor.addEventListener('input', updateHistory);

    // Initial load
    loadCode();
}

async function fetchContributions() {
    const display = document.getElementById('contribution-display');
    display.innerHTML = `<p>Loading...</p>`;
    try {
        const response = await fetch(CONTRIBUTIONS_WORKER_URL);
        const contributions = await response.json();
        if (contributions && contributions.length > 0) {
            display.innerHTML = contributions.reverse().map(c => {
                // Removed mediaHTML generation, only text will be displayed
                return `<div style="background:rgba(0,0,0,0.2);padding:10px;border-radius:5px;margin-bottom:10px;">
                    <p style="margin:0;">${c.text}</p>
                    <small style="color:var(--text-secondary);">${new Date(c.timestamp).toLocaleString()}</small>
                </div>`;
            }).join('');
        } else {
            display.innerHTML = `<p>Be the first to leave a message!</p>`;
        }
    } catch (e) {
        display.innerHTML = `<p style="color:var(--danger);">Could not load contributions.</p>`;
    }
}

document.getElementById('contribution-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const statusEl = document.getElementById('contribution-status');
    statusEl.textContent = 'Uploading...';
    const formData = new FormData();
    formData.append('text', document.getElementById('contribution-text').value);
    // Removed file input handling
    try {
        const response = await fetch(CONTRIBUTIONS_WORKER_URL, { method: 'POST', body: formData });
        if (!response.ok) throw new Error('Upload failed');
        statusEl.textContent = 'Message sent! Thank you.';
        e.target.reset();
        fetchContributions();
    } catch (err) {
        statusEl.textContent = `Error: ${err.message}`;
    }
});

function getBrowserId() {
    let browserId = localStorage.getItem('unique_browser_id');
    if (!browserId) {
        browserId = 'browser_' + Math.random().toString(36).substr(2, 9) + Date.now();
        localStorage.setItem('unique_browser_id', browserId);
    }
    return browserId;
}

async function trackVisitor() {
    try {
        const browserId = getBrowserId();
        let ipAddress = 'unknown';

        try {
            const ipResponse = await fetch('https://api.ipify.org?format=json');
            const ipData = await ipResponse.json();
            ipAddress = ipData.ip;
        } catch (ipError) {
            console.warn('Could not fetch IP address:', ipError);
        }

        const data = {
            browserId: browserId,
            ip: ipAddress,
            userAgent: navigator.userAgent,
            timestamp: new Date().toISOString()
        };

        fetch(LIVE_VISITORS_WORKER_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
        }).catch(e => console.error("Error sending to live visitors worker:", e));

    } catch(e) {
        console.error('Error in trackVisitor:', e);
    }
}

async function fetchLiveVisitors() {
    const visitorList = document.getElementById('visitor-list');
    const lastUpdatedTime = document.getElementById('last-updated-time');
    
    if (!visitorList.innerHTML.trim()) {
        visitorList.innerHTML = '<li style="text-align: center; color: var(--text-secondary);">Loading visitors...</li>'; 
    }
    
    try {
        const response = await fetch(LIVE_VISITORS_WORKER_URL + '?get_visitors=true'); 
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const visitors = await response.json();

        if (visitors && visitors.length > 0) {
            visitorList.innerHTML = visitors.map(visitor => {
                const timestamp = new Date(visitor.timestamp).toLocaleString('id-ID', {
                    hour: '2-digit', minute: '2-digit', second: '2-digit',
                    day: '2-digit', month: '2-digit', year: 'numeric'
                });
                return `
                    <li>
                        <strong>ID:</strong> <span>${visitor.browserId.substring(0, 10)}...</span><br>
                        <strong>IP:</strong> <span>${visitor.ip || 'N/A'}</span><br>
                        <strong>Waktu:</strong> <span>${timestamp}</span>
                    </li>
                `;
            }).join('');
        } else {
            visitorList.innerHTML = '<li style="text-align: center; color: var(--text-secondary);">No visitors online.</li>';
        }
        lastUpdatedTime.textContent = new Date().toLocaleTimeString('id-ID');

    } catch (error) {
        console.error('Error fetching live visitors:', error);
        visitorList.innerHTML = '<li style="text-align: center; color: var(--danger);">Failed to load visitors.</li>';
        lastUpdatedTime.textContent = 'Error';
    }
}

// --- Backend Gallery Functions ---
async function fetchGalleryContent() {
    const galleryItemsContainer = document.getElementById('gallery-items');
    galleryItemsContainer.innerHTML = `<p style="text-align: center; color: var(--text-secondary);">Loading moments...</p>`;
    if (GALLERY_WORKER_URL === 'YOUR_GALLERY_WORKER_URL_HERE') {
        galleryItemsContainer.innerHTML = `<p style="text-align: center; color: var(--danger);">Please set your GALLERY_WORKER_URL_HERE in index.html to fetch content.</p>`;
        return;
    }
    try {
        const response = await fetch(GALLERY_WORKER_URL);
        const items = await response.json();
        if (items && items.length > 0) {
            galleryItemsContainer.innerHTML = items.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).map(item => {
                let mediaHtml = '';
                const fileExtension = item.fileUrl.split('.').pop().toLowerCase();
                if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(fileExtension)) {
                    mediaHtml = `<img src="${item.fileUrl}" alt="${item.description || 'Gallery image'}">`;
                } else if (['mp4', 'webm', 'ogg'].includes(fileExtension)) {
                    mediaHtml = `<video src="${item.fileUrl}" controls></video>`;
                } else if (['mp3', 'wav', 'ogg'].includes(fileExtension)) {
                    mediaHtml = `<audio src="${item.fileUrl}" controls></audio>`;
                } else {
                    mediaHtml = `<a href="${item.fileUrl}" target="_blank" style="color:var(--accent);"><i class="fas fa-file"></i> Download File</a>`;
                }

                return `
                    <div class="gallery-item">
                        <div class="media-container">
                            ${mediaHtml}
                        </div>
                        <p style="margin: 5px 0;">${item.description || 'No description'}</p>
                        <small style="color:var(--text-secondary);">${new Date(item.timestamp).toLocaleString()}</small>
                    </div>
                `;
            }).join('');
        } else {
            galleryItemsContainer.innerHTML = `<p style="text-align: center; color: var(--text-secondary);">No moments uploaded yet.</p>`;
        }
    } catch (error) {
        console.error('Error fetching gallery content:', error);
        galleryItemsContainer.innerHTML = `<p style="text-align: center; color: var(--danger);">Failed to load moments.</p>`;
    }
}

document.getElementById('gallery-upload-btn').addEventListener('click', async () => {
    const description = document.getElementById('gallery-description').value;
    const fileInput = document.getElementById('gallery-file-input');
    const uploadStatus = document.getElementById('gallery-upload-status');

    if (!fileInput.files.length) {
        uploadStatus.textContent = 'Please select a file to upload.';
        uploadStatus.style.color = 'var(--danger)';
        return;
    }
    if (GALLERY_WORKER_URL === 'YOUR_GALLERY_WORKER_URL_HERE') {
        uploadStatus.textContent = 'ERROR: Gallery Worker URL not set!';
        uploadStatus.style.color = 'var(--danger)';
        return;
    }

    uploadStatus.textContent = 'Uploading...';
    uploadStatus.style.color = 'var(--text-secondary)';

    const formData = new FormData();
    formData.append('description', description);
    formData.append('file', fileInput.files[0]);

    try {
        const response = await fetch(GALLERY_WORKER_URL, {
            method: 'POST',
            body: formData,
        });

        if (response.ok) {
            uploadStatus.textContent = 'Upload successful!';
            uploadStatus.style.color = 'var(--success)';
            document.getElementById('gallery-description').value = '';
            fileInput.value = ''; // Clear file input
            fetchGalleryContent(); // Refresh gallery
        } else {
            const errorText = await response.text();
            throw new Error(`Upload failed: ${response.status} ${response.statusText} - ${errorText}`);
        }
    } catch (error) {
        console.error('Gallery upload error:', error);
        uploadStatus.textContent = `Upload failed: ${error.message}`;
        uploadStatus.style.color = 'var(--danger)';
    }
});

</script>
</body>
</html>
