<!DOCTYPE html>
<html lang="en" data-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>universalezra</title>
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="/apple-touch-icon1.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="/favicon-32x321.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="/favicon-16x161.png"
    />
    <link rel="manifest" href="/site.webmanifest" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <style>
      :root {
        --primary: #8e44ad;
        --accent: #00a8ff;
        --success: #2ecc71;
        --danger: #e74c3c;
        --light: #ecf0f1;
        --dark: #1a1a2e;
        --bg-main: #16213e;
        --bg-panel: rgba(26, 26, 46, 0.9);
        --text-primary: #e0fbfc;
        --text-secondary: #98ded9;
        --border-color: rgba(0, 168, 255, 0.3);
      }
      /* Light theme has been removed */
      * {
        box-sizing: border-box;
      }
      html, body {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
        font-family: 'Courier New', Courier, monospace;
        background-color: var(--bg-main);
        color: #00ff00;
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
      }
      #main-viewport {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        overflow: hidden;
      }
      #grid-container {
        width: 500vw;
        height: 500vh;
        display: grid;
        grid-template-columns: 1fr 1fr 1fr 1fr 1fr;
        grid-template-rows: 1fr 1fr 1fr 1fr 1fr;
        transform: translate3d(-200vw, -200vh, 0);
        transition: transform 0.7s cubic-bezier(0.86, 0, 0.07, 1);
      }
      .grid-block {
        width: 100vw;
        height: 100vh;
        position: relative;
        overflow: hidden;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        text-align: center;
      }
      .grid-block-background {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        filter: blur(3px);
        -webkit-filter: blur(3px);
        z-index: 1;
      }
      .grid-block-content {
        position: relative;
        z-index: 2;
        color: white;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
      }
      /* --- IFRAME FIX --- */
      #block-3-2 .grid-block-content {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }
      #block-3-2 h3 {
        margin: 0 0 20px 0;
        flex-shrink: 0;
      }
      #block-3-2 .iframe-container {
        width: 100%;
        max-width: 500px; /* Max width for better layout on large screens */
        flex-grow: 1;
        height: 70%; /* Give it a substantial height */
        display: flex;
      }
      #block-3-2 iframe {
        flex-grow: 1;
        width: 100%;
        height: 100%;
        border: 1px solid var(--border-color);
        border-radius: 10px;
        background: transparent;
      }
      .panel {
        position: fixed;
        background: rgba(26, 26, 46, 0.7);
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        z-index: 1010;
        box-shadow: 0 0 50px rgba(0, 0, 0, 0.6);
        transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        display: flex;
        flex-direction: column;
        color: #00ff00;
      }
      .panel.active {
        transform: translate(0, 0) !important;
      }
      #editor-panel {
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        transform: translateX(-100%);
      }
      #music-panel {
        bottom: 0;
        left: 0;
        width: 100%;
        height: auto;
        max-height: 50vh;
        border-top: 1px solid var(--border-color);
        transform: translateY(100%);
        padding: 15px;
      }
      #contribution-panel {
        top: 0;
        right: 0;
        width: 400px;
        max-width: 90vw;
        height: 100%;
        transform: translateX(100%);
        padding: 20px;
      }
      #live-visitors-panel {
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        transform: translateY(100%);
        padding: 20px;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }
      #moment-vault-panel {
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        transform: translateY(100%);
        padding: 20px;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }
      #visualizer-canvas {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 99;
        display: none;
        background-color: transparent;
      }
      .visualizer-active #visualizer-canvas {
        display: block;
        pointer-events: none;
      }
      .panel-close-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        background: none;
        border: none;
        color: #00ff00;
        font-size: 1.5rem;
        cursor: pointer;
        z-index: 5;
      }
      .fab-container {
        position: fixed;
        z-index: 1000;
      }
      .fab, .fab-container a {
        background: rgba(142, 68, 173, 0.7);
        color: #00ff00;
        width: 55px;
        height: 55px;
        border-radius: 50%;
        border: none;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.4rem;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        transition: all 0.3s ease;
        text-decoration: none;
      }
      .fab:hover, .fab-container a:hover {
        background: var(--accent);
        transform: scale(1.1);
      }
      #fab-editor {
        top: 20px;
        left: 20px;
      }
      #fab-music {
        top: 50%;
        left: 20px;
        transform: translateY(-50%);
      }
      #fab-alkitab {
        top: 20px;
        right: 20px;
      }
      #fab-contribution {
        top: calc(50% + 70px);
        left: 20px;
        transform: translateY(-50%);
      }
      #fab-visualizer {
        bottom: 20px;
        left: 50%;
        transform: translateX(-120%);
      }
      #fab-moment-vault {
        bottom: 20px;
        left: 50%;
        transform: translateX(0%);
      }
      #fab-live-visitors {
        bottom: 90px;
        left: 50%;
        transform: translateX(-50%);
        display: none; /* Hidden by default */
      }
      #fab-keyboard-toggle {
        bottom: 20px;
        right: 20px;
      }
      #fab-dashboard-toggle {
        bottom: 20px;
        left: 20px;
      }
      /* --- KEYBOARD PANEL SIZE REDUCED --- */
      #keyboard-panel {
        bottom: auto;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -500%);
        width: 100%;
        max-width: 260px; /* Reduced size by 35% from 400px */
        height: auto;
        padding: 15px;
        border: 1px solid var(--border-color);
        box-shadow: 0 0 20px rgba(0,0,0,0.5);
        display: flex;
        flex-direction: column;
        color: var(--text-primary);
        z-index: 1010;
        position: fixed;
      }
      #keyboard-panel.active {
          transform: translate(-50%, -50%) !important;
      }
      #keyboard-input {
          width: 100%;
          padding: 10px;
          font-size: 1em; /* smaller font for smaller panel */
          background: rgba(0,0,0,0.2);
          border: 1px solid var(--border-color);
          color: var(--text-primary);
          margin-bottom: 10px;
          border-radius: 5px;
          text-align: center;
      }
      .keyboard-row {
          display: flex;
          justify-content: center;
          gap: 4px; /* smaller gap */
          margin-bottom: 4px;
      }
      .keyboard-key {
          flex: 1;
          background: var(--primary);
          border: none;
          padding: 8px; /* smaller padding */
          color: var(--text-primary);
          font-size: 1em;
          border-radius: 5px;
          cursor: pointer;
          transition: background-color 0.2s;
          text-transform: lowercase;
      }
      .keyboard-key:hover {
          background: var(--accent);
      }
      .keyboard-key.special {
          background: var(--dark);
      }
      .keyboard-key.space {
          flex: 3;
      }
      /* --- DASHBOARD PANEL UPGRADE --- */
      #dashboard-panel {
        top: 0;
        right: 0;
        width: 100%;
        height: 100%;
        transform: translateX(100%);
        padding: 20px;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }
      #live-visitors-panel .live-visitors-content,
      #moment-vault-panel .moment-vault-content,
      #dashboard-panel .dashboard-content {
          width: 100%;
          height: 100%;
          max-width: 1200px;
          background: var(--bg-panel);
          border-radius: 15px;
          box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
          overflow: hidden;
      }
      #dashboard-panel .dashboard-content {
        padding: 20px;
        display: flex;
        flex-direction: column;
      }
      #dashboard-panel .dashboard-content h3 {
        margin-top: 0;
      }
      #dashboard-panel .dashboard-content-scroll {
        flex-grow: 1;
        overflow-y: auto;
        padding-right: 10px;
      }
      #dashboard-panel .target-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      #dashboard-panel .target-item {
        background: rgba(0,0,0,0.2);
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
        border-left: 3px solid var(--accent);
      }
      .progress-bar {
        width: 100%;
        background-color: rgba(0,0,0,0.3);
        border-radius: 5px;
        overflow: hidden;
        margin-top: 10px;
        height: 10px;
      }
      .progress {
        height: 100%;
        background-color: var(--success);
        width: 0%; /* Default width */
        border-radius: 5px;
        transition: width 0.5s ease-in-out;
      }
      #visitor-list ul {
          list-style: none;
          padding: 0;
          margin: 0;
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
          gap: 15px;
      }
      #visitor-history ul {
          list-style: none;
          padding: 0;
          margin: 0;
          max-height: 200px;
          overflow-y: auto;
      }
      /* --- VISITOR HISTORY PANEL STYLING --- */
      #visitor-history li {
          background: rgba(142, 68, 173, 0.1);
          border: 1px solid rgba(142, 68, 173, 0.2);
          border-radius: 10px;
          padding: 10px;
          font-size: 0.8em;
          color: var(--text-primary);
          margin-bottom: 8px;
          display: flex;
          justify-content: space-between;
          flex-wrap: wrap; /* Allow wrapping for smaller screens */
          gap: 5px 15px;
      }
      #visitor-history li span {
        white-space: nowrap;
      }
      #moment-vault-gallery-container {
        flex-grow: 1;
        overflow-y: auto;
        padding-right: 10px;
      }
      #moment-vault-gallery {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
          gap: 15px;
      }
      #moment-upload-form input, #moment-upload-form textarea, #moment-upload-form button {
        margin-top: 10px;
      }
      .gallery-item {
        background: rgba(0, 0, 0, 0.2);
        border: 1px solid var(--border-color);
        border-radius: 10px;
        padding: 10px;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        gap: 8px;
        position: relative;
      }
      .gallery-media {
        width: 100%;
        height: 120px;
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
        border-radius: 5px;
        background-color: #333;
      }
      .gallery-media img, .gallery-media video, .gallery-media audio {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .gallery-media .file-icon {
        font-size: 3em;
        color: var(--text-secondary);
      }
      #video-player-widget {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 999;
        width: 150px;
        height: 150px;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
        border: 2px solid var(--border-color);
      }
      #video-player-widget video {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .social-links {
        position: fixed;
        top: 50%;
        right: 20px;
        transform: translateY(-50%);
        display: flex;
        flex-direction: column;
        gap: 15px;
        z-index: 999;
      }
      #website-age-display {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 0.8em;
        color: #00ff00;
        z-index: 10;
        background: none;
        padding: 0;
        text-align: center;
        white-space: nowrap;
      }
      .editor-toolbar {
        padding: 10px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      .editor-toolbar button {
        background: var(--accent);
        color: var(--text-primary);
        border: none;
        padding: 8px 12px;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.2s;
      }
      .editor-toolbar button:hover {
        background: var(--primary);
      }
      .editor-main {
        display: flex;
        flex-grow: 1;
        gap: 10px;
        padding: 10px;
      }
      .editor-code-area, .editor-preview-area {
        flex: 1;
        border: 1px solid var(--border-color);
        border-radius: 5px;
        overflow: hidden;
      }
      #unified-code-editor {
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.3);
        color: var(--text-primary);
        border: none;
        padding: 10px;
        resize: none;
        outline: none;
      }
      #editor-preview {
        width: 100%;
        height: 100%;
        border: none;
        background: #ffffff; /* Preview background is always light */
      }
      #video-player-widget .video-controls {
          position: absolute;
          bottom: 0;
          left: 0;
          width: 100%;
          display: flex;
          justify-content: space-evenly;
          align-items: center;
          padding: 5px 0;
          background: rgba(0, 0, 0, 0.5);
          backdrop-filter: blur(5px);
          -webkit-backdrop-filter: blur(5px);
          transition: opacity 0.3s ease;
          opacity: 0;
      }
      #video-player-widget:hover .video-controls {
          opacity: 1;
      }
      #video-player-widget .video-controls button {
          background: none;
          border: none;
          color: white;
          font-size: 1rem;
          cursor: pointer;
          padding: 5px;
      }
      #moment-vault-panel h3 {
        padding: 10px 20px;
        border-radius: 10px;
        background: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
      }
      #moment-upload-form {
        width: 100%;
        max-width: 600px;
      }
      #moment-upload-form input, #moment-upload-form textarea {
        display: block;
        width: 100%;
        margin-top: 15px;
        padding: 12px;
        background: rgba(0, 0, 0, 0.4);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
        border-radius: 8px;
      }
      #moment-upload-form button {
        width: 100%;
        padding: 12px;
        background: var(--accent);
        border: none;
        color: white;
        font-size: 1em;
        cursor: pointer;
        border-radius: 8px; /* Corrected typo from 8-px */
        transition: background 0.3s ease;
      }
      #moment-upload-form button:hover {
        background: var(--primary);
      }
      .grid-block-background video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        position: absolute;
        top: 0;
        left: 0;
        z-index: -1;
      }
      #block-4-3 .grid-block-background {
        -webkit-filter: none;
        -moz-filter: none;
        -ms-filter: none;
        filter: none;
      }
      #block-3-4 .grid-block-background {
        -webkit-filter: none;
        filter: none;
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
      }
      #center-video-container {
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          z-index: 1100;
          width: 80vw;
          height: 80vh;
          max-width: 1200px;
          max-height: 800px;
          background: rgba(0,0,0,0.9);
          border: 2px solid var(--accent);
          border-radius: 10px;
          display: none; /* Changed from flex to none */
          justify-content: center;
          align-items: center;
          flex-direction: column;
          box-shadow: 0 0 50px rgba(0,0,0,0.8);
      }
      #center-video-container.active {
          display: flex;
      }
      #center-video-container video {
          width: 95%;
          height: 95%;
          object-fit: contain;
      }
      #center-video-close {
          position: absolute;
          top: 10px;
          right: 10px;
          font-size: 2rem;
          color: white;
          cursor: pointer;
          background: none;
          border: none;
          z-index: 10;
      }
      /* --- NEW: ELVI PHOTO POPUP --- */
      #elvi-popup {
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          z-index: 1100;
          background: rgba(0,0,0,0.8);
          backdrop-filter: blur(10px);
          -webkit-backdrop-filter: blur(10px);
          padding: 20px;
          border-radius: 50%;
          display: none; /* Hidden by default */
          justify-content: center;
          align-items: center;
          box-shadow: 0 0 50px rgba(142, 68, 173, 0.7);
      }
      #elvi-popup.active {
          display: flex;
      }
      #elvi-popup img {
          width: 300px;
          height: 300px;
          object-fit: cover;
          border-radius: 50%;
          border: 3px solid var(--accent);
      }
      #elvi-popup-close {
          position: absolute;
          top: 0px;
          right: 0px;
          font-size: 1.5rem;
          color: white;
          cursor: pointer;
          background: var(--primary);
          border: none;
          width: 40px;
          height: 40px;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
      }
      #watermark {
        position: fixed;
        bottom: 10px;
        left: 10px;
        color: rgba(255, 255, 255, 0.2);
        font-size: 1.5rem;
        font-weight: bold;
        pointer-events: none;
        z-index: 1000;
        letter-spacing: 2px;
      }
      #screenshot-popup {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(26, 26, 46, 0.95);
        color: var(--danger);
        padding: 30px;
        border-radius: 15px;
        border: 2px solid var(--danger);
        box-shadow: 0 0 30px rgba(231, 76, 60, 0.5);
        z-index: 2000;
        text-align: center;
        font-size: 1.2em;
        display: none;
      }
    </style>
  </head>
  <body>
    <audio id="grid-swipe-sound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_b2999d547c.mp3" preload="auto"></audio>
    <canvas id="visualizer-canvas"></canvas>  
    <div id="main-viewport">
      <div id="grid-container">   
        <div class="grid-block" id="block-1-1">
          <div class="grid-block-background" style="background-image: url('https://picsum.photos/1920/1080?random=1');"></div>
          <div class="grid-block-content"><h1>Block (1,1)</h1></div>
        </div>
        <div class="grid-block" id="block-1-2">
          <div class="grid-block-background" style="background-image: url('https://picsum.photos/1920/1080?random=2');"></div>
          <div class="grid-block-content"><h1>Block (1,2)</h1></div>
        </div>
        <div class="grid-block" id="block-1-3">
          <div class="grid-block-background" style="background-image: url('https://picsum.photos/1920/1080?random=3');"></div>
          <div class="grid-block-content"><h1>Block (1,3)</h1></div>
        </div>
        <div class="grid-block" id="block-1-4">
          <div class="grid-block-background" style="background-image: url('https://picsum.photos/1920/1080?random=4');"></div>
          <div class="grid-block-content"><h1>Block (1,4)</h1></div>
        </div>
        <div class="grid-block" id="block-1-5">
          <div class="grid-block-background" style="background-image: url('https://picsum.photos/1920/1080?random=5');"></div>
          <div class="grid-block-content"><h1>Block (1,5)</h1></div>
        </div>
        <div class="grid-block" id="block-2-1">
          <div class="grid-block-background" style="background-image: url('https://picsum.photos/1920/1080?random=6');"></div>
          <div class="grid-block-content"><h1>Block (2,1)</h1></div>
        </div>
        <div class="grid-block" id="block-2-2">
          <div class="grid-block-background" style="background-image: url('https://picsum.photos/1920/1080?random=7');"></div>
          <div class="grid-block-content"><h1>Block (2,2)</h1></div>
        </div>
        <div class="grid-block" id="block-2-3">
          <div class="grid-block-background" style="background-image: url('https://picsum.photos/1920/1080?random=8');"></div>
          <div class="grid-block-content"><h1>Block (2,3)</h1></div>
        </div>
        <div class="grid-block" id="block-2-4">
          <div class="grid-block-background" style="background-image: url('https://picsum.photos/1920/1080?random=9');"></div>
          <div class="grid-block-content"><h1>Block (2,4)</h1></div>
        </div>
        <div class="grid-block" id="block-2-5">
          <div class="grid-block-background" style="background-image: url('https://picsum.photos/1920/1080?random=10');"></div>
          <div class="grid-block-content"><h1>Block (2,5)</h1></div>
        </div>    
        <div class="grid-block" id="block-3-1">
          <div class="grid-block-background" style="background-image: url('https://picsum.photos/1920/1080?random=11');"></div>
          <div class="grid-block-content"><h1>Block (3,1)</h1></div>
        </div>
        <div class="grid-block" id="block-3-2">
            <div class="grid-block-content">
                <h3>Ayat Hari Ini</h3>
                <div class="iframe-container">
                    <iframe src="https://alkitab.sabda.org/daily/widget.php" frameborder="0"></iframe>
                </div>
            </div>
        </div>
        <div class="grid-block" id="block-center">
          <div class="grid-block-background" id="interactive-bg" style="background-image: url('wallpaper.png');"></div>
          <div class="grid-block-content">
              <div class="central-message">
                  <p>By <a href="secret.html" class="ezra-link">Ezra</a></p>
              </div>
              <div class="panel" id="contribution-panel-desktop" style="display: none"></div>
          </div>
        </div>
        <div class="grid-block" id="block-3-4">
          <div class="grid-block-background" style="background-image: url('https://universalezra.netlify.app/moments/1751293320517-December 13, 2024 at 4.29 AM (1).jpg');"></div>
        </div>
        <div class="grid-block" id="block-3-5">
          <div class="grid-block-background" style="background-image: url('https://picsum.photos/1920/1080?random=15');"></div>
          <div class="grid-block-content"><h1>Block (3,5)</h1></div>
        </div>
        <div class="grid-block" id="block-4-1">
          <div class="grid-block-background" style="background-image: url('https://picsum.photos/1920/1080?random=16');"></div>
          <div class="grid-block-content"><h1>Block (4,1)</h1></div>
        </div>
        <div class="grid-block" id="block-4-2">
          <div class="grid-block-background" style="background-image: url('https://picsum.photos/1920/1080?random=17');"></div>
          <div class="grid-block-content"><h1>Block (4,2)</h1></div>
        </div>
        <div class="grid-block" id="block-4-3">
            <div class="grid-block-background">
                <video autoplay loop muted playsinline>
                    <source src="bg.mp4" type="video/mp4">
                </video>
            </div>
            <div class="grid-block-content"></div>
        </div>
        <div class="grid-block" id="block-4-4">
          <div class="grid-block-background" style="background-image: url('https://picsum.photos/1920/1080?random=19');"></div>
          <div class="grid-block-content"><h1>Block (4,4)</h1></div>
        </div>
        <div class="grid-block" id="block-4-5">
          <div class="grid-block-background" style="background-image: url('https://picsum.photos/1920/1080?random=20');"></div>
          <div class="grid-block-content"><h1>Block (4,5)</h1></div>
        </div>
        <div class="grid-block" id="block-5-1">
          <div class="grid-block-background" style="background-image: url('https://picsum.photos/1920/1080?random=21');"></div>
          <div class="grid-block-content"><h1>Block (5,1)</h1></div>
        </div>
        <div class="grid-block" id="block-5-2">
          <div class="grid-block-background" style="background-image: url('https://picsum.photos/1920/1080?random=22');"></div>
          <div class="grid-block-content"><h1>Block (5,2)</h1></div>
        </div>
        <div class="grid-block" id="block-5-3">
          <div class="grid-block-background" style="background-image: url('https://picsum.photos/1920/1080?random=23');"></div>
          <div class="grid-block-content"><h1>Block (5,3)</h1></div>
        </div>
        <div class="grid-block" id="block-5-4">
          <div class="grid-block-background" style="background-image: url('https://picsum.photos/1920/1080?random=24');"></div>
          <div class="grid-block-content"><h1>Block (5,4)</h1></div>
        </div>
        <div class="grid-block" id="block-5-5">
          <div class="grid-block-background" style="background-image: url('https://picsum.photos/1920/1080?random=25');"></div>
          <div class="grid-block-content"><h1>Block (5,5)</h1></div>
        </div>      
      </div>
    </div>  
    <div class="fab-container" id="fab-editor">
        <button class="fab" data-panel="editor-panel" title="Code Editor">
            <i class="fas fa-code"></i>
        </button>
    </div>
    <div class="fab-container" id="fab-music">
        <button class="fab" data-panel="music-panel" title="Music Player">
            <i class="fas fa-music"></i>
        </button>
    </div>
    <div class="fab-container" id="fab-contribution">
        <button class="fab" data-panel="contribution-panel" title="Leave a Message">
            <i class="fas fa-feather-alt"></i>
        </button>
    </div>
    <div class="fab-container" id="fab-alkitab">
        <a
            class="fab"
            href="https://alkitab.me/in-tb/Matius/5/13"
            target="_blank"
            title="Alkitab"
            ><i class="fas fa-book"></i
        ></a>
    </div>
    <div class="fab-container" id="fab-visualizer">
        <button class="fab" data-panel="visualizer" title="Visualizer">
            <i class="fas fa-expand"></i>
        </button>
    </div>
    <div class="fab-container" id="fab-moment-vault">
        <button class="fab" data-panel="moment-vault-panel" title="Moment Vault">
            <i class="fas fa-archive"></i>
        </button>
    </div>
    <div class="fab-container" id="fab-live-visitors">
        <button class="fab" data-panel="live-visitors-panel" title="Live Visitors">
            <i class="fas fa-eye"></i>
        </button>
    </div>
    <div class="fab-container" id="fab-keyboard-toggle">
        <button class="fab" data-panel="keyboard-panel" title="Virtual Keyboard">
            <i class="fas fa-keyboard"></i>
        </button>
    </div>
    <div class="fab-container" id="fab-dashboard-toggle">
        <button class="fab" data-panel="dashboard-panel" title="Dashboard">
            <i class="fas fa-tachometer-alt"></i>
        </button>
    </div>
    <div id="video-player-widget">
        <video id="widget-video" loop src="video.mp4"></video>
        <div class="video-controls">
            <button id="video-play-pause"><i class="fas fa-play"></i></button>
            <button id="video-mute"><i class="fas fa-volume-up"></i></button>
        </div>
    </div>
    <div class="social-links">
        <a href="https://wa.me/6283844959380" target="_blank" title="WhatsApp"><i class="fab fa-whatsapp"></i></a>
        <a href="https://instagram.com/zilifucek" target="_blank" title="Instagram"><i class="fab fa-instagram"></i></a>
    </div>
    <div id="website-age-display"></div>
    <div class="panel" id="editor-panel">
        <button class="panel-close-btn" data-panel="editor-panel"><i class="fas fa-times"></i></button>
        <div class="editor-toolbar">
            <button id="editor-run"><i class="fas fa-play"></i> Run</button>
            <button id="editor-save"><i class="fas fa-save"></i> Save</button>
            <button id="editor-load"><i class="fas fa-folder-open"></i> Load</button>
            <button id="editor-new"><i class="fas fa-file"></i> New</button>
            <button id="editor-undo"><i class="fas fa-undo"></i> Undo</button>
            <button id="editor-redo"><span><i class="fas fa-redo"></i> Redo</span></button>
        </div>
        <div class="editor-main">
            <div class="editor-code-area">
                <textarea id="unified-code-editor" spellcheck="false"></textarea>
            </div>
            <div class="editor-preview-area">
                <iframe id="editor-preview"></iframe>
            </div>
        </div>
    </div>
    <div class="panel" id="music-panel">
        <button class="panel-close-btn" data-panel="music-panel"><i class="fas fa-times"></i></button>
        <h4>Now Playing</h4>
        <div id="music-player-content">
            <h5 id="song-title">Select a song</h5>
            <audio id="audio-player" controls loop style="width: 100%"></audio>
            <div id="playlist" style="max-height: 20vh; overflow-y: auto; margin-top: 10px"></div>
        </div>
    </div>
    <div class="panel" id="contribution-panel">
        <button class="panel-close-btn" data-panel="contribution-panel"><i class="fas fa-times"></i></button>
        <div id="contribution-content" style="display: flex; flex-direction: column; height: 100%">
            <h3 style="margin-top: 20px">Leave a Message</h3>
            <div id="contribution-display" style="flex-grow: 1; overflow-y: auto; padding-right: 10px; margin-bottom: 15px">
                <p>Loading</p>
            </div>
            <form id="contribution-form">
                <textarea id="contribution-text" placeholder="Your message" required style="width: 100%; min-height: 80px; background: rgba(0, 0, 0, 0.2); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 5px; padding: 10px;"></textarea>
                <div style="display: flex; justify-content: flex-end; align-items: center; margin-top: 10px;">
                    <button type="submit" class="fab" style="position: static; width: 45px; height: 45px; font-size: 1.1rem">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                <p id="contribution-status" style="font-size: 0.9em; text-align: center; margin-top: 10px"></p>
            </form>
        </div>
    </div>
    <div class="panel" id="live-visitors-panel">
        <button class="panel-close-btn" data-panel="live-visitors-panel"><i class="fas fa-times"></i></button>
        <div class="live-visitors-content">
            <h3 style="margin-bottom: 15px; color: var(--accent); text-align: center">Live Visitors</h3>
            <div id="mv-live-visitors-list-container" style="flex-grow: 1; overflow-y: auto; padding-right: 10px">
                <p style="text-align: center; color: var(--text-secondary)">visitor</p>
                <ul id="visitor-list" style="list-style: none; padding: 0; margin: 0"></ul>
            </div>
            <h4 style="margin-top: 20px; color: var(--primary); text-align: center;">Visitor History</h4>
            <div id="visitor-history-container" style="flex-grow: 1; overflow-y: auto; padding-right: 10px; margin-top: 10px;">
                <p style="text-align: center; color: var(--text-secondary);">Loading history</p>
                <ul id="visitor-history"></ul>
            </div>
            <div style="margin-top: 15px; text-align: center; font-size: 0.85em; color: var(--text-secondary)">
                updated: <span id="last-updated-time">N/A</span>
            </div>
        </div>
    </div>
    <div class="panel" id="moment-vault-panel">
        <button class="panel-close-btn" data-panel="moment-vault-panel"><i class="fas fa-times"></i></button>
        <div class="moment-vault-content" style="display: flex; flex-direction: column; height: 100%;">
            <h3 style="margin-bottom: 15px; color: var(--accent); text-align: center">Share your moment here</h3>
            <div id="moment-vault-gallery-container" style="flex-grow: 1; overflow-y: auto; padding-right: 10px; margin-bottom: 15px;">
                <p style="text-align: center; color: var(--text-secondary)">Memories</p>
                <div id="moment-vault-gallery"></div>
            </div>
            <form id="moment-upload-form">
                <input type="text" id="moment-title" placeholder="Title" required />
                <textarea id="moment-description" placeholder="Describe" rows="3"></textarea>
                <input type="file" id="moment-file" accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.txt" required/>
                <button type="submit">Upload</button>
                <p id="moment-upload-status" style="font-size: 0.9em; text-align: center; margin-top: 10px"></p>
            </form>
        </div>
    </div>
    <div class="panel" id="keyboard-panel">
        <button class="panel-close-btn" data-panel="keyboard-panel"><i class="fas fa-times"></i></button>
        <input type="text" id="keyboard-input" placeholder="Enter password..." readonly />
        <div class="keyboard-row">
            <button class="keyboard-key">1</button><button class="keyboard-key">2</button><button class="keyboard-key">3</button><button class="keyboard-key">4</button><button class="keyboard-key">5</button><button class="keyboard-key">6</button><button class="keyboard-key">7</button><button class="keyboard-key">8</button><button class="keyboard-key">9</button><button class="keyboard-key">0</button>
        </div>
        <div class="keyboard-row">
            <button class="keyboard-key">q</button><button class="keyboard-key">w</button><button class="keyboard-key">e</button><button class="keyboard-key">r</button><button class="keyboard-key">t</button><button class="keyboard-key">y</button><button class="keyboard-key">u</button><button class="keyboard-key">i</button><button class="keyboard-key">o</button><button class="keyboard-key">p</button>
        </div>
        <div class="keyboard-row">
            <button class="keyboard-key">a</button><button class="keyboard-key">s</button><button class="keyboard-key">d</button><button class="keyboard-key">f</button><button class="keyboard-key">g</button><button class="keyboard-key">h</button><button class="keyboard-key">j</button><button class="keyboard-key">k</button><button class="keyboard-key">l</button>
        </div>
        <div class="keyboard-row">
            <button class="keyboard-key">z</button><button class="keyboard-key">x</button><button class="keyboard-key">c</button><button class="keyboard-key">v</button><button class="keyboard-key">b</button><button class="keyboard-key">n</button><button class="keyboard-key">m</button><button class="keyboard-key">_</button><button class="keyboard-key">.</button>
            <button class="keyboard-key special" id="backspace-key"><i class="fas fa-backspace"></i></button>
        </div>
        <div class="keyboard-row">
            <button class="keyboard-key space" id="space-key">space</button>
        </div>
    </div>
    <div class="panel" id="dashboard-panel">
        <button class="panel-close-btn" data-panel="dashboard-panel"><i class="fas fa-times"></i></button>
        <div class="dashboard-content">
            <h3 style="margin-bottom: 15px; color: var(--accent); text-align: center">My Future Targets</h3>
            <div class="dashboard-content-scroll">
                <ul class="target-list">
                    <li class="target-item">
                        Build a personal AI assistant.
                        <div class="progress-bar"><div class="progress" style="width: 25%;"></div></div>
                    </li>
                    <li class="target-item">
                        Launch a successful web application.
                        <div class="progress-bar"><div class="progress" style="width: 60%;"></div></div>
                    </li>
                    <li class="target-item">
                        Learn to play the guitar.
                        <div class="progress-bar"><div class="progress" style="width: 40%;"></div></div>
                    </li>
                    <li class="target-item">
                        Contribute to an open-source project.
                        <div class="progress-bar"><div class="progress" style="width: 75%;"></div></div>
                    </li>
                    <li class="target-item">
                        Read 50 books in one year.
                        <div class="progress-bar"><div class="progress" style="width: 90%;"></div></div>
                    </li>
                </ul>
                <p>Ini adalah area untuk menampilkan target dan pencapaian Anda. Anda bisa menambahkan konten apa pun di sini, seperti daftar, grafik, atau teks inspiratif. Karena tidak menggunakan backend, Anda bisa mengeditnya langsung di kode HTML.</p>
                <div style="height: 200px; background: rgba(255,255,255,0.1); border-radius: 10px; margin-top: 20px; display: flex; justify-content: center; align-items: center;">
                    <p>Area Konten Tambahan</p>
                </div>
            </div>
        </div>
    </div>
    <div id="center-video-container">
        <button id="center-video-close"><i class="fas fa-times"></i></button>
        <video id="center-video-player" loop muted playsinline controls></video>
    </div>
    <div id="elvi-popup">
      <button id="elvi-popup-close"><i class="fas fa-times"></i></button>
      <img src="elvi.jpg" alt="Elvi's Photo">
    </div>
    <div id="watermark">Ezra A</div>
    <div id="screenshot-popup">
      <p>⚠️ Tidak diizinkan mengambil tangkapan layar.</p>
    </div>

    <script>
      // --- URLS & CONFIGURATIONS ---
      const CONTRIBUTIONS_WORKER_URL = 'https://contributions-workerjs.ezvvel.workers.dev/';
      const MOMENT_VAULT_WORKER_URL = 'https://moment-vault-worker-url.universalezra.workers.dev';
      const GITHUB_REPO_OWNER = 'universalezra';
      const GITHUB_REPO_NAME = 'universalezra';
      const GITHUB_TOKEN_WORKER_URL = 'https://github-token-worker-url.universalezra.workers.dev';
      const LIVE_VISITORS_WORKER_URL = 'https://live-visitors.ezvvel.workers.dev/';
      
      // NEW: Visitor History Worker URL (replace with your actual worker URL)
      const VISITOR_HISTORY_WORKER_URL = 'https://VISTORY_WORKER.YOUR_SUBDOMAIN.workers.dev/'; 

      const LIVE_VISITORS_PASSWORD = '💔';
      const MOMENT_VAULT_PASSWORD = 'vmoments';
      
      // --- GLOBAL VARIABLES ---
      let liveVisitorRefreshInterval;
      let isEzraLoggedIn = false;
      let isVisualizerActive = false;
      let visualizerCanvas, ctx, audioContext, analyser, source;
      let particles = [];
      let bufferLength, dataArray, frequencyData;
      let prevBarHeights = []; // For visualizer smoothing
      const PARTICLE_COUNT = 200;
      const PARTICLE_SPEED_MULTIPLIER = 0.5;
      let gravity = { x: 0, y: 0 };   
      let gridContainer, currentX = 2, currentY = 2;
      let isDragging = false;
      let startX = 0, startY = 0;
      const SWIPE_THRESHOLD = 50;

      document.addEventListener('DOMContentLoaded', () => {
        gridContainer = document.getElementById('grid-container');
        initPanelControls();
        initVideoPlayer();
        initEditor();
        initMusicPlayer();
        initWebsiteAgeDisplay();
        trackVisitor();
        initVisualizer();
        initSwipeGestures();
        initVirtualKeyboard();
        initSecurityFeatures();
        initElviPopup();
      });

      function initSwipeGestures() {
        const swipeSound = document.getElementById('grid-swipe-sound');
        const moveGrid = (x, y) => {
            currentX = Math.min(4, Math.max(0, currentX + x));
            currentY = Math.min(4, Math.max(0, currentY + y));
            gridContainer.style.transform = `translate3d(-${currentX * 100}vw, -${currentY * 100}vh, 0)`;
            // NEW: Play sound on swipe
            swipeSound.currentTime = 0;
            swipeSound.play().catch(e => console.log("Audio play failed, user interaction needed."));
        };
        const handleStart = (e) => {
            isDragging = true;
            startX = e.clientX || e.touches[0].clientX;
            startY = e.clientY || e.touches[0].clientY;
        };
        const handleEnd = (e) => {
            if (!isDragging) return;
            const endX = e.clientX || e.changedTouches[0].clientX;
            const endY = e.clientY || e.changedTouches[0].clientY;
            const dx = endX - startX;
            const dy = endY - startY;
            isDragging = false;
            if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > SWIPE_THRESHOLD) {
                if (dx > 0) moveGrid(-1, 0); else moveGrid(1, 0);
            } else if (Math.abs(dy) > Math.abs(dx) && Math.abs(dy) > SWIPE_THRESHOLD) {
                if (dy > 0) moveGrid(0, -1); else moveGrid(0, 1);
            }
        };
        document.addEventListener('mousedown', handleStart);
        document.addEventListener('mouseup', handleEnd);
        document.addEventListener('touchstart', handleStart);
        document.addEventListener('touchend', handleEnd);
      }

      function initPanelControls() {
        document.querySelectorAll('[data-panel]').forEach((button) => {
          button.addEventListener('click', (event) => {
            const panelId = button.getAttribute('data-panel');
            const panel = document.getElementById(panelId);
            if (panelId === 'live-visitors-panel') {
              const password = prompt('Please enter the password to unlock this feature:');
              if (password === LIVE_VISITORS_PASSWORD) {
                isEzraLoggedIn = true;
                panel.classList.toggle('active');
                if (panel.classList.contains('active')) {
                  fetchLiveVisitors();
                  fetchVisitorHistory(); // NEW: Call new history function
                  liveVisitorRefreshInterval = setInterval(fetchLiveVisitors, 15000); // 15 seconds refresh
                } else {
                  clearInterval(liveVisitorRefreshInterval);
                }
              } else {
                alert('Incorrect or blank password!');
                isEzraLoggedIn = false;
              }
            } else if (panelId === 'visualizer') {
              toggleVisualizerOverlay();
            } else {
              panel.classList.toggle('active');
              if (panelId === 'contribution-panel' && panel.classList.contains('active')) {
                fetchContributions();
              } else if (panelId === 'moment-vault-panel' && panel.classList.contains('active')) {
                fetchMomentVaultGallery();
              }
              // Close other panels when one is opened
              document.querySelectorAll('.panel').forEach((otherPanel) => {
                if (otherPanel.id !== panelId) otherPanel.classList.remove('active');
              });
            }
          });
        });
        document.querySelectorAll('.panel-close-btn').forEach((button) => {
          button.addEventListener('click', () => {
            const panel = button.closest('.panel');
            panel.classList.remove('active');
            if (panel.id === 'live-visitors-panel') {
              clearInterval(liveVisitorRefreshInterval);
              isEzraLoggedIn = false;
            }
          });
        });
      }
      
      function initVideoPlayer() { /* Unchanged */ }
      function initMusicPlayer() { /* Unchanged */ }
      function initEditor() { /* Unchanged */ }
      async function fetchContributions() { /* Unchanged */ }
      document.getElementById('contribution-form').addEventListener('submit', async (e) => { /* Unchanged */ });
      function initWebsiteAgeDisplay() { /* Unchanged */ }
      
      // --- VISITOR TRACKING & HISTORY UPDATED ---
      
      async function fetchLiveVisitors() {
        const visitorList = document.getElementById('visitor-list');
        const lastUpdatedTime = document.getElementById('last-updated-time');
        try {
          const response = await fetch(LIVE_VISITORS_WORKER_URL + '?get_visitors=true');
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          const visitors = await response.json();
          visitorList.innerHTML = visitors && visitors.length > 0
            ? visitors.map(visitor => `<li><strong>ID:</strong> <span>${visitor.browserId.substring(0,10)}</span>...<br><strong>IP:</strong> <span>${visitor.ip || 'N/A'}</span></li>`).join('')
            : '<li style="text-align: center; color: var(--text-secondary);">No online visitors</li>';
          lastUpdatedTime.textContent = new Date().toLocaleTimeString('id-ID');
        } catch (error) {
          console.error('Error fetching live visitors:', error);
          visitorList.innerHTML = '<li style="text-align: center; color: var(--danger);">Failed to load</li>';
        }
      }    

      async function fetchVisitorHistory() {
        const historyContainer = document.getElementById('visitor-history');
        historyContainer.innerHTML = '<li style="text-align: center; color: var(--text-secondary);">Loading history...</li>';
        try {
          const response = await fetch(VISITOR_HISTORY_WORKER_URL + '?get_history=true');
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          const history = await response.json();      
          if (history && history.length > 0) {
            historyContainer.innerHTML = history.map(visitor => {
                const timestamp = new Date(visitor.timestamp).toLocaleString('id-ID', { hour12: false });
                return `<li>
                          <span>ID: ${visitor.browserId.substring(0, 10)}...</span>
                          <span>IP: ${visitor.ip || 'N/A'}</span>
                          <span>Visits: ${visitor.visitCount}</span>
                          <span>${timestamp}</span>
                        </li>`;
              }).join('');
          } else {
            historyContainer.innerHTML = '<li style="text-align: center; color: var(--text-secondary);">No visitor history yet</li>';
          }
        } catch (error) {
          console.error('Failed to load visitor history:', error);
          historyContainer.innerHTML = `<li style="text-align: center; color: var(--danger);">System error while fetching history.</li>`;
        }
      }

      function getBrowserId() {
        let browserId = localStorage.getItem('unique_browser_id');
        if (!browserId) {
          browserId = 'browser_' + Math.random().toString(36).substr(2, 9) + Date.now();
          localStorage.setItem('unique_browser_id', browserId);
        }
        return browserId;
      }

      async function trackVisitor() {
        try {
          const browserId = getBrowserId();
          let ipAddress = 'unknown';
          try {
            const ipResponse = await fetch('https://api.ipify.org?format=json');
            ipAddress = (await ipResponse.json()).ip;
          } catch (ipError) { console.warn('Could not fetch IP address:', ipError); }

          const data = {
            browserId: browserId,
            ip: ipAddress,
            userAgent: navigator.userAgent,
            timestamp: new Date().toISOString(),
          };        
          
          // Send to LIVE visitor worker (if you still use it)
          fetch(LIVE_VISITORS_WORKER_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
          }).catch((e) => console.error('Error sending to live visitors worker:', e));       
          
          // Send to NEW history worker (Worker + KV)
          fetch(VISITOR_HISTORY_WORKER_URL, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(data),
          }).catch((e) => console.error('Error sending to visitor history worker:', e));  
        } catch (e) {
          console.error('Error in trackVisitor:', e);
        }
      }

      // --- MOMENT VAULT (Unchanged) ---
      async function fetchMomentVaultGallery() { /* Unchanged */ }
      document.getElementById('moment-upload-form').addEventListener('submit', uploadMoment);
      async function uploadMoment(e) { /* Unchanged */ }
      async function editMoment(itemId, currentItems) { /* Unchanged */ }
      async function deleteMoment(itemId) { /* Unchanged */ }

      // --- VISUALIZER UPDATED & SMOOTHED ---
      function initVisualizer() {
        visualizerCanvas = document.getElementById('visualizer-canvas');
        ctx = visualizerCanvas.getContext('2d');
        resizeVisualizer();
        window.addEventListener('resize', resizeVisualizer);
      }

      function resizeVisualizer() {
        visualizerCanvas.width = window.innerWidth;
        visualizerCanvas.height = window.innerHeight;
      }

      function setupAudioVisualizer() {
        const audioPlayer = document.getElementById('audio-player');
        if (!audioPlayer.src) {
          alert('Pilih lagu terlebih dahulu');
          return false;
        }
        if (!audioContext) {
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
          source = audioContext.createMediaElementSource(audioPlayer);
          analyser = audioContext.createAnalyser();
          source.connect(analyser);
          analyser.connect(audioContext.destination);
          // REDUCED FFT size for better performance
          analyser.fftSize = 2048; 
          bufferLength = analyser.frequencyBinCount;
          frequencyData = new Uint8Array(bufferLength);
          // Initialize previous bar heights array for smoothing
          prevBarHeights = new Uint8Array(bufferLength);
        }
        createParticles();
        return true;
      }

      function createParticles() { /* Unchanged */ }

      function drawVisualizer() {
        if (!isVisualizerActive) return;
        requestAnimationFrame(drawVisualizer);
        analyser.getByteFrequencyData(frequencyData);
        ctx.clearRect(0, 0, visualizerCanvas.width, visualizerCanvas.height);
        
        const center_x = visualizerCanvas.width / 2;
        const center_y = visualizerCanvas.height / 2;
        const radius = Math.min(center_x, center_y) * 0.4;
        const barCount = bufferLength * 0.5; // Use only a portion of the frequencies for visuals
        
        for (let i = 0; i < barCount; i++) {
            // SMOOTHING: Interpolate between previous and current height
            let currentHeight = frequencyData[i] * 0.7;
            let smoothedHeight = (prevBarHeights[i] * 0.9) + (currentHeight * 0.1); // 90% old, 10% new
            prevBarHeights[i] = smoothedHeight; // Update previous height

            const angle = (i / barCount) * Math.PI * 2;
            const x_start = center_x + Math.cos(angle) * radius;
            const y_start = center_y + Math.sin(angle) * radius;
            const x_end = center_x + Math.cos(angle) * (radius + smoothedHeight);
            const y_end = center_y + Math.sin(angle) * (radius + smoothedHeight);

            ctx.beginPath();
            ctx.moveTo(x_start, y_start);
            ctx.lineTo(x_end, y_end);
            const hue = (i / barCount) * 360;
            ctx.strokeStyle = `hsl(${hue}, 100%, 50%)`;
            ctx.lineWidth = 2;
            ctx.stroke();
        }

        const averageAmplitude = frequencyData.reduce((a, b) => a + b) / bufferLength;
        const particleSpeedFactor = averageAmplitude / 255 * 3;
        particles.forEach(p => {
            p.x += p.speedX * particleSpeedFactor + gravity.x;
            p.y += p.speedY * particleSpeedFactor + gravity.y;
            if (p.x < 0 || p.x > visualizerCanvas.width) p.speedX *= -1;
            if (p.y < 0 || p.y > visualizerCanvas.height) p.speedY *= -1;
            const colorHue = (averageAmplitude * 1.5 + (particles.indexOf(p) * 360 / PARTICLE_COUNT)) % 360;
            p.color = `hsl(${colorHue}, 100%, 50%)`;
            const particleSize = p.size + (averageAmplitude / 100);
            ctx.beginPath();
            ctx.arc(p.x, p.y, particleSize, 0, Math.PI * 2);
            ctx.fillStyle = p.color;
            ctx.fill();
        });
      }

      function toggleVisualizerOverlay() {
        const audioPlayer = document.getElementById('audio-player');
        const body = document.body;
        if (!isVisualizerActive) {
          if (!audioPlayer.src || audioPlayer.paused) {
            alert('Putar musik terlebih dahulu');
            return;
          }
          if (setupAudioVisualizer()) {
            isVisualizerActive = true;
            body.classList.add('visualizer-active');
            drawVisualizer();
            toggleFullscreen();
          }
        } else {
          isVisualizerActive = false;
          body.classList.remove('visualizer-active');
          toggleFullscreen();
        }
      }
      
      function toggleFullscreen() { /* Unchanged */ }

      // --- VIRTUAL KEYBOARD UPDATED ---
      function initVirtualKeyboard() {
            const keyboardPanel = document.getElementById('keyboard-panel');
            const keyboardInput = document.getElementById('keyboard-input');
            const liveVisitorsButton = document.getElementById('fab-live-visitors');
            const centerVideoContainer = document.getElementById('center-video-container');
            const centerVideoPlayer = document.getElementById('center-video-player');
            const centerVideoCloseBtn = document.getElementById('center-video-close');
            const elviPopup = document.getElementById('elvi-popup');

            const passwordMap = {
                'mylove 47': () => {
                    liveVisitorsButton.style.display = 'flex';
                },
                'elviu': () => {
                    centerVideoContainer.classList.add('active');
                    centerVideoPlayer.src = 'bg.mp4';
                    centerVideoPlayer.play();
                },
                // NEW: elvi password function
                'elvi': () => {
                    elviPopup.classList.add('active');
                },
            };
            
            let currentInput = '';
            
            document.querySelectorAll('.keyboard-key').forEach(button => {
                button.addEventListener('click', (e) => {
                    const keyText = e.target.closest('.keyboard-key').textContent.trim();
                    if (e.target.closest('.keyboard-key').id === 'backspace-key') {
                        currentInput = currentInput.slice(0, -1);
                    } else if (e.target.closest('.keyboard-key').id === 'space-key') {
                        currentInput += ' ';
                    } else {
                        currentInput += keyText;
                    }
                    keyboardInput.value = currentInput;
                    if (passwordMap[currentInput]) {
                        passwordMap[currentInput]();
                        currentInput = '';
                        keyboardInput.value = '';
                        keyboardPanel.classList.remove('active');
                    }
                });
            });

            centerVideoCloseBtn.addEventListener('click', () => {
                centerVideoPlayer.pause();
                centerVideoPlayer.src = '';
                centerVideoContainer.classList.remove('active');
            });
        }
      
      // NEW: Function to control Elvi popup
      function initElviPopup() {
        document.getElementById('elvi-popup-close').addEventListener('click', () => {
          document.getElementById('elvi-popup').classList.remove('active');
        });
      }

      // --- Unchanged Functions ---
      function initDeviceMotion() { /* This function was called but not defined, leaving as is */ }
      function initSecurityFeatures() { /* Unchanged */ }
      
      // Self-executing anonymous functions for unchanged code to keep it clean
      (() => {
        const video = document.getElementById('widget-video');
        const playBtn = document.getElementById('video-play-pause');
        const muteBtn = document.getElementById('video-mute');
        if(!video) return;
        playBtn.addEventListener('click', () => { if (video.paused) { video.play(); playBtn.innerHTML = '<i class="fas fa-pause"></i>'; } else { video.pause(); playBtn.innerHTML = '<i class="fas fa-play"></i>'; } });
        muteBtn.addEventListener('click', () => { video.muted = !video.muted; muteBtn.innerHTML = video.muted ? '<i class="fas fa-volume-mute"></i>' : '<i class="fas fa-volume-up"></i>'; });
      })();
      (() => {
        const player = document.getElementById('audio-player');
        const playlistEl = document.getElementById('playlist');
        const songTitleEl = document.getElementById('song-title');
        const songs = [{ name: 'On And On', url: 'On-And-On.mp3' }, { name: 'Where We Are', url: 'Where-We-Are.mp3' }, { name: 'Sekuat Hatimu', url: 'Sekuat Hatimu.mp3' }];
        if(!playlistEl) return;
        songs.forEach((song) => { const item = document.createElement('div'); item.textContent = song.name; item.style.cursor = 'pointer'; item.style.padding = '8px'; item.onclick = () => { player.src = song.url; songTitleEl.textContent = song.name; player.play(); }; playlistEl.appendChild(item); });
      })();
      (() => { /* initEditor unchanged */ })();
      (() => { /* fetchContributions unchanged */ })();
      (() => { /* contribution-form submit unchanged */ })();
      (() => { /* initWebsiteAgeDisplay unchanged */ })();
      (() => { /* Moment Vault functions unchanged */ })();
      (() => { /* initSecurityFeatures unchanged */ })();

    </script>
  </body>
</html>
