<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=1200"> 
    <title>Ezra's Personal Site</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* --- General Variables & Base Styles --- */
        :root {
            --primary: #8e44ad;
            --accent: #00a8ff;
            --success: #2ecc71;
            --danger: #e74c3c;
            --light: #ecf0f1;
            --dark: #1a1a2e;
            --bg-main: #000; /* Black background */
            --bg-panel: rgba(26, 26, 46, 0.95);
            --text-primary: #ecf0f1;
            --text-secondary: #bdc3c7;
            --border-color: #34495e;
            --input-bg: rgba(0, 0, 0, 0.3);
            --button-hover-bg: rgba(255, 255, 255, 0.1);
            --header-height: 60px; /* Define header height */
        }

        [data-theme="light"] {
            --bg-main: #f0f2f5;
            --bg-panel: rgba(255, 255, 255, 0.95);
            --text-primary: #34495e;
            --text-secondary: #7f8c8d;
            --border-color: #bdc3c7;
            --input-bg: rgba(255, 255, 255, 0.7);
            --button-hover-bg: rgba(0, 0, 0, 0.05);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            height: 100%;
            overflow: hidden; /* Prevent scroll on body to manage custom scrolling for panels */
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-main); /* Solid black background */
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        button {
            cursor: pointer;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            background-color: var(--primary);
            color: var(--light);
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: var(--accent);
        }

        input, textarea {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            background-color: var(--input-bg);
            color: var(--text-primary);
            width: 100%;
            margin-bottom: 10px;
            resize: vertical;
        }

        a {
            color: var(--accent);
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        /* --- Header --- */
        header {
            width: 100%;
            height: var(--header-height);
            background-color: rgba(0, 0, 0, 0.7); /* Slightly transparent black */
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            z-index: 1000; /* Ensure header is on top */
        }

        header .logo {
            font-size: 1.8em;
            font-weight: bold;
            color: var(--primary);
        }

        header .header-controls {
            display: flex;
            gap: 15px;
        }

        header .header-controls button {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 5px;
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }

        header .header-controls button:hover {
            background-color: var(--button-hover-bg);
            border-color: var(--accent);
        }

        /* --- Main Content Area (Layout: Header + Wide Content) --- */
        .main-content {
            flex-grow: 1; /* Occupy remaining vertical space */
            display: flex;
            justify-content: center; /* Center content horizontally */
            align-items: flex-start; /* Align content to top vertically */
            padding: 20px;
            overflow-y: auto; /* Allow scrolling for main content if it overflows */
            /* Removed max-width to let it expand */
            margin: 0 auto; /* Center main content block */
        }

        .main-content-wrapper {
            display: grid;
            /* Force more columns for horizontal feel */
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 20px;
            width: 100%; /* Take full width of main-content */
            min-width: 1160px; /* Ensure a minimum width to force desktop-like scroll */
        }

        /* --- Panel Styles (Re-used for general panels) --- */
        .panel {
            background-color: var(--bg-panel);
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            padding: 20px;
            backdrop-filter: blur(5px);
            border: 1px solid var(--border-color);
            position: relative; /* For close button positioning */
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Hide overflow by default for panels */
        }
        .panel.hidden {
            display: none;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }

        .panel-header h3 {
            color: var(--primary);
            font-size: 1.4em;
        }

        .panel .close-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.2em;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .panel .close-btn:hover {
            color: var(--danger);
        }

        /* --- Specific Panel Overrides --- */
        #code-editor-panel {
            min-height: 400px; /* Make editor panel larger */
        }
        #code-editor-panel textarea {
            flex-grow: 1; /* Make textarea fill available space */
            font-family: 'Fira Code', 'Cascadia Code', monospace; /* Monospaced font for code */
            font-size: 0.9em;
            white-space: pre;
            word-wrap: normal;
            overflow: auto;
        }
        #code-preview {
            width: 100%;
            height: 200px; /* Fixed height for preview */
            border: 1px solid var(--border-color);
            background-color: var(--light); /* Light background for preview */
            border-radius: 5px;
            margin-top: 10px;
        }

        #music-player-panel .audio-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        #music-player-panel audio {
            width: 100%;
            margin-top: 15px;
        }
        #playlist-items {
            list-style: none;
            margin-top: 10px;
            padding: 0;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 5px;
        }
        #playlist-items li {
            padding: 8px 10px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #playlist-items li.active {
            background-color: var(--primary);
            color: var(--light);
        }
        #playlist-items li:hover {
            background-color: var(--button-hover-bg);
        }

        #contribute-panel form {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        #contribute-panel textarea {
            min-height: 80px;
        }
        #contribute-panel button {
            align-self: flex-end;
        }
        #contribute-message {
            margin-top: 10px;
            font-size: 0.9em;
            color: var(--text-secondary);
            text-align: center;
        }

        /* Live Visitors Panel */
        #live-visitors-panel {
            min-height: 300px;
            display: none; /* Default to hidden, shown only for Ezra */
        }
        #live-visitors-panel ul {
            list-style: none;
            padding: 0;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            margin-bottom: 10px;
        }
        #live-visitors-panel ul li {
            padding: 8px 10px;
            border-bottom: 1px dashed var(--border-color);
            font-size: 0.9em;
        }
        #live-visitors-panel ul li:last-child {
            border-bottom: none;
        }
        #live-visitors-panel .refresh-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8em;
            color: var(--text-secondary);
            margin-top: 10px;
        }

        /* --- Floating Action Buttons (FABs) - Kept for mobile convenience if desired --- */
        .fab-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 999; /* Below header, above other elements */
        }

        .fab {
            background-color: var(--primary);
            color: var(--light);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 1.5em;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        .fab:hover {
            background-color: var(--accent);
            transform: scale(1.05);
        }

        /* --- Social Links (Fixed position) --- */
        .social-links {
            position: fixed;
            bottom: 20px;
            left: 20px;
            display: flex;
            gap: 15px;
            z-index: 999;
        }

        .social-links a {
            color: var(--text-primary);
            font-size: 1.8em;
            transition: color 0.2s ease, transform 0.2s ease;
        }

        .social-links a:hover {
            color: var(--primary);
            transform: scale(1.1);
        }

        /* --- Private User Panel (for initial login) --- */
        #private-user-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 400px;
            padding: 30px;
            z-index: 1001;
            text-align: center;
        }
        #private-user-panel h3 {
            margin-bottom: 20px;
        }
        #private-user-panel input {
            margin-bottom: 15px;
            text-align: center;
        }
        #private-user-panel button {
            width: 100%;
        }

        /* --- Ezra Panel (Full-Screen, Editable Gallery) --- */
        #ezra-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.98); /* Almost black, slightly transparent */
            z-index: 1002; /* Above all other elements */
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto; /* Allow scrolling within this panel */
            transition: opacity 0.3s ease, visibility 0.3s ease;
            visibility: hidden;
            opacity: 0;
        }
        #ezra-panel.active {
            visibility: visible;
            opacity: 1;
        }

        #ezra-panel .panel-header {
            justify-content: flex-end; /* Logout button only */
            margin-bottom: 20px;
        }
        #ezra-panel .panel-header h3 {
            flex-grow: 1; /* Take remaining space */
            text-align: center;
            color: var(--accent);
            font-size: 2em;
        }
        #ezra-panel .logout-btn {
            background-color: var(--danger);
            color: var(--light);
        }
        #ezra-panel .logout-btn:hover {
            background-color: #c0392b;
        }

        #ezra-gallery-container {
            flex-grow: 1;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            padding: 20px;
            background-color: rgba(26, 26, 46, 0.8); /* Slightly lighter background for gallery area */
            border-radius: 8px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .gallery-item {
            background-color: var(--bg-panel);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border-color);
        }

        .gallery-item img, .gallery-item video {
            width: 100%;
            height: 200px;
            object-fit: cover;
            display: block;
        }

        .gallery-item-info {
            padding: 15px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .gallery-item-info h4 {
            color: var(--primary);
            margin-bottom: 5px;
            font-size: 1.2em;
        }

        .gallery-item-info p {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-bottom: 10px;
            flex-grow: 1;
        }

        .gallery-item-info small {
            font-size: 0.8em;
            color: var(--text-secondary);
            text-align: right;
        }

        .gallery-item-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 5px;
            padding: 5px;
        }

        .gallery-item-controls button {
            background: none;
            border: none;
            color: var(--light);
            font-size: 1em;
            padding: 5px;
        }

        .gallery-item-controls button:hover {
            color: var(--accent);
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* --- Ezra Content Editor Form --- */
        #ezra-content-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            background-color: var(--bg-panel);
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        #ezra-content-form h4 {
            color: var(--accent);
            margin-bottom: 10px;
        }
        #ezra-content-form .form-row {
            display: flex;
            gap: 10px;
        }
        #ezra-content-form .form-row input, #ezra-content-form .form-row textarea {
            flex-grow: 1;
        }
        #ezra-content-form button {
            align-self: flex-end;
            margin-top: 10px;
        }
        .message-status {
            color: var(--text-primary);
            text-align: center;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">Ezra's DevLog</div>
        <div class="header-controls">
            <button id="theme-toggle">
                <i class="fas fa-sun"></i> / <i class="fas fa-moon"></i>
            </button>
            <button id="show-code-editor">Code Editor</button>
            <button id="show-music-player">Music Player</button>
            <button id="show-contribute">Contribute</button>
            <button id="show-live-visitors" class="hidden">Live Visitors</button> <button id="show-private-user"><i class="fas fa-user-secret"></i></button>
        </div>
    </header>

    <main class="main-content">
        <div class="main-content-wrapper">
            <div id="code-editor-panel" class="panel">
                <div class="panel-header">
                    <h3>Code Editor</h3>
                    <button class="close-btn"><i class="fas fa-times"></i></button>
                </div>
                <textarea id="unified-editor" spellcheck="false" placeholder="Tulis HTML, CSS, dan JavaScript Anda di sini..."></textarea>
                <button id="run-code">Run Code</button>
                <h4>Preview:</h4>
                <iframe id="code-preview" sandbox="allow-scripts allow-forms allow-same-origin"></iframe>
            </div>

            <div id="music-player-panel" class="panel">
                <div class="panel-header">
                    <h3>Music Player</h3>
                    <button class="close-btn"><i class="fas fa-times"></i></button>
                </div>
                <audio id="music-audio" controls></audio>
                <div class="audio-controls">
                    <button id="play-pause-btn"><i class="fas fa-play"></i></button>
                    <button id="prev-btn"><i class="fas fa-backward"></i></button>
                    <button id="next-btn"><i class="fas fa-forward"></i></button>
                    <button id="shuffle-btn"><i class="fas fa-random"></i></button>
                    <button id="repeat-btn"><i class="fas fa-redo"></i></button>
                </div>
                <h4>Playlist:</h4>
                <ul id="playlist-items">
                    </ul>
            </div>

            <div id="contribute-panel" class="panel">
                <div class="panel-header">
                    <h3>Kontribusi Pesan</h3>
                    <button class="close-btn"><i class="fas fa-times"></i></button>
                </div>
                <form id="contribute-form">
                    <input type="text" id="contributor-name" placeholder="Nama Anda (opsional)">
                    <textarea id="contribute-text" placeholder="Tulis pesan Anda di sini..." required></textarea>
                    <button type="submit">Kirim Pesan</button>
                </form>
                <p id="contribute-message"></p>
            </div>

            <div id="live-visitors-panel" class="panel hidden">
                <div class="panel-header">
                    <h3>Live Visitors</h3>
                    <button class="close-btn"><i class="fas fa-times"></i></button>
                </div>
                <ul id="visitor-list">
                    <li>Loading visitors...</li>
                </ul>
                <div class="refresh-info">
                    <small>Last updated: <span id="last-updated-time">N/A</span></small>
                    <button id="refresh-visitors-btn">Refresh</button>
                </div>
                <p style="text-align: center; font-size: 0.8em; color: var(--text-secondary); margin-top: 10px;">
                    *Fitur ini hanya terlihat ketika Anda login sebagai Ezra.
                </p>
            </div>
        </div>
    </main>

    <div class="fab-container">
        <button class="fab" id="fab-theme-toggle" aria-label="Toggle Theme"><i class="fas fa-adjust"></i></button>
        <button class="fab" id="fab-code-editor" aria-label="Open Code Editor"><i class="fas fa-code"></i></button>
        <button class="fab" id="fab-music-player" aria-label="Open Music Player"><i class="fas fa-music"></i></button>
        <button class="fab" id="fab-contribute" aria-label="Contribute Message"><i class="fas fa-comment-dots"></i></button>
        <button class="fab hidden" id="fab-live-visitors" aria-label="Live Visitors"><i class="fas fa-eye"></i></button> <button class="fab" id="fab-private-user" aria-label="Private User Access"><i class="fas fa-user-secret"></i></button>
    </div>

    <div class="social-links">
        <a href="https://wa.me/yourwhatsappnumber" target="_blank" aria-label="WhatsApp"><i class="fab fa-whatsapp"></i></a>
        <a href="https://instagram.com/yourinstagram" target="_blank" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
        <a href="https://github.com/yourgithub" target="_blank" aria-label="GitHub"><i class="fab fa-github"></i></a>
        <a href="#" aria-label="Bible Link"><i class="fas fa-book-bible"></i></a> </div>

    <div id="private-user-panel" class="panel hidden">
        <div class="panel-header">
            <h3>Login</h3>
            <button class="close-btn" data-target="private-user-panel"><i class="fas fa-times"></i></button>
        </div>
        <input type="text" id="private-user-input" placeholder="Masukkan Username Pribadi">
        <button id="private-user-submit">Login</button>
        <p id="private-user-message" style="color: var(--danger); margin-top: 10px;"></p>
    </div>

    <div id="ezra-panel" class="panel hidden">
        <div class="panel-header">
            <h3>Ezra's Private Space</h3>
            <button class="logout-btn" id="ezra-logout-btn">Logout</button>
        </div>
        
        <div id="ezra-gallery-container">
            <p id="ezra-gallery-status" style="color: var(--text-secondary); text-align: center;">Loading content...</p>
        </div>

        <form id="ezra-content-form">
            <h4>Tambah / Edit Konten</h4>
            <input type="hidden" id="edit-item-id">
            <div class="form-row">
                <input type="text" id="gallery-item-title" placeholder="Judul Konten" required>
                <input type="file" id="gallery-item-media" accept="image/*,video/*">
            </div>
            <textarea id="gallery-item-description" placeholder="Deskripsi Konten" rows="3" required></textarea>
            <button type="submit" id="submit-gallery-item">Tambah Konten Baru</button>
            <p id="ezra-form-status" class="message-status"></p>
        </form>
    </div>

    <script>
        // --- CONSTANTS ---
        const CLOUDFLARE_WORKER_URL = 'YOUR_CLOUDFLARE_WORKER_URL'; // GANTI DENGAN URL CLOUDFLARE WORKER ANDA!

        // --- DOM ELEMENTS ---
        const body = document.body;
        const themeToggle = document.getElementById('theme-toggle');
        const fabThemeToggle = document.getElementById('fab-theme-toggle');

        // Panel toggles (header buttons)
        const showCodeEditorBtn = document.getElementById('show-code-editor');
        const showMusicPlayerBtn = document.getElementById('show-music-player');
        const showContributeBtn = document.getElementById('show-contribute');
        const showLiveVisitorsBtn = document.getElementById('show-live-visitors'); // Live Visitors button
        const showPrivateUserBtn = document.getElementById('show-private-user');

        // Panel toggles (FABs)
        const fabCodeEditorBtn = document.getElementById('fab-code-editor');
        const fabMusicPlayerBtn = document.getElementById('fab-music-player');
        const fabContributeBtn = document.getElementById('fab-contribute');
        const fabLiveVisitorsBtn = document.getElementById('fab-live-visitors'); // FAB for Live Visitors
        const fabPrivateUserBtn = document.getElementById('fab-private-user');

        // Panels
        const codeEditorPanel = document.getElementById('code-editor-panel');
        const musicPlayerPanel = document.getElementById('music-player-panel');
        const contributePanel = document.getElementById('contribute-panel');
        const liveVisitorsPanel = document.getElementById('live-visitors-panel'); // Live Visitors panel
        const privateUserPanel = document.getElementById('private-user-panel');
        const ezraPanel = document.getElementById('ezra-panel');

        // Close buttons
        document.querySelectorAll('.panel .close-btn').forEach(button => {
            button.addEventListener('click', () => {
                const targetPanelId = button.dataset.target || button.closest('.panel').id;
                document.getElementById(targetPanelId).classList.add('hidden');
            });
        });

        // --- THEME TOGGLE ---
        function toggleTheme() {
            if (body.dataset.theme === 'dark') {
                body.dataset.theme = 'light';
            } else {
                body.dataset.theme = 'dark';
            }
        }
        themeToggle.addEventListener('click', toggleTheme);
        fabThemeToggle.addEventListener('click', toggleTheme);

        // --- PANEL MANAGEMENT (General) ---
        function showPanel(panel) {
            // Hide all other main panels if they are not Ezra panel
            [codeEditorPanel, musicPlayerPanel, contributePanel, liveVisitorsPanel, privateUserPanel].forEach(p => {
                if (p !== panel && p !== ezraPanel) {
                    p.classList.add('hidden');
                }
            });
            panel.classList.remove('hidden');
        }

        showCodeEditorBtn.addEventListener('click', () => showPanel(codeEditorPanel));
        fabCodeEditorBtn.addEventListener('click', () => showPanel(codeEditorPanel));

        showMusicPlayerBtn.addEventListener('click', () => showPanel(musicPlayerPanel));
        fabMusicPlayerBtn.addEventListener('click', () => showPanel(musicPlayerPanel));

        showContributeBtn.addEventListener('click', () => showPanel(contributePanel));
        fabContributeBtn.addEventListener('click', () => showPanel(contributePanel));

        // Logic for Live Visitors panel visibility based on Ezra login
        showLiveVisitorsBtn.addEventListener('click', () => {
            showPanel(liveVisitorsPanel);
            fetchLiveVisitors(); // Refresh visitors when panel is shown
        });
        fabLiveVisitorsBtn.addEventListener('click', () => {
            showPanel(liveVisitorsPanel);
            fetchLiveVisitors(); // Refresh visitors when panel is shown
        });

        showPrivateUserBtn.addEventListener('click', () => showPanel(privateUserPanel));
        fabPrivateUserBtn.addEventListener('click', () => showPanel(privateUserPanel));


        // --- CODE EDITOR LOGIC ---
        const unifiedEditor = document.getElementById('unified-editor');
        const runCodeBtn = document.getElementById('run-code');
        const codePreview = document.getElementById('code-preview');

        runCodeBtn.addEventListener('click', () => {
            const code = unifiedEditor.value;
            // The sandbox attribute is important for security!
            codePreview.srcdoc = code;
        });

        // --- MUSIC PLAYER LOGIC ---
        const musicAudio = document.getElementById('music-audio');
        const playPauseBtn = document.getElementById('play-pause-btn');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const shuffleBtn = document.getElementById('shuffle-btn');
        const repeatBtn = document.getElementById('repeat-btn');
        const playlistItems = document.getElementById('playlist-items');

        const playlist = [
            { title: "Music 1", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" },
            { title: "Music 2", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3" },
            { title: "Music 3", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3" }
        ];

        let currentTrackIndex = 0;
        let isShuffling = false;
        let isRepeating = false;

        function loadTrack(index) {
            if (index >= 0 && index < playlist.length) {
                currentTrackIndex = index;
                musicAudio.src = playlist[currentTrackIndex].src;
                musicAudio.play();
                updatePlaylistUI();
                playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
            }
        }

        function playPause() {
            if (musicAudio.paused) {
                musicAudio.play();
                playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
            } else {
                musicAudio.pause();
                playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
            }
        }

        function nextTrack() {
            if (isShuffling) {
                let newIndex;
                do {
                    newIndex = Math.floor(Math.random() * playlist.length);
                } while (newIndex === currentTrackIndex && playlist.length > 1); // Avoid playing same song twice in a row if only 2 songs
                loadTrack(newIndex);
            } else {
                currentTrackIndex = (currentTrackIndex + 1) % playlist.length;
                loadTrack(currentTrackIndex);
            }
        }

        function prevTrack() {
            currentTrackIndex = (currentTrackIndex - 1 + playlist.length) % playlist.length;
            loadTrack(currentTrackIndex);
        }

        function toggleShuffle() {
            isShuffling = !isShuffling;
            shuffleBtn.classList.toggle('active', isShuffling);
            shuffleBtn.style.color = isShuffling ? 'var(--accent)' : 'var(--light)';
        }

        function toggleRepeat() {
            isRepeating = !isRepeating;
            musicAudio.loop = isRepeating;
            repeatBtn.classList.toggle('active', isRepeating);
            repeatBtn.style.color = isRepeating ? 'var(--accent)' : 'var(--light)';
        }

        function updatePlaylistUI() {
            playlistItems.innerHTML = '';
            playlist.forEach((song, index) => {
                const li = document.createElement('li');
                li.textContent = song.title;
                if (index === currentTrackIndex) {
                    li.classList.add('active');
                }
                li.addEventListener('click', () => loadTrack(index));
                playlistItems.appendChild(li);
            });
        }

        musicAudio.addEventListener('ended', () => {
            if (isRepeating) {
                musicAudio.play();
            } else {
                nextTrack();
            }
        });

        playPauseBtn.addEventListener('click', playPause);
        nextBtn.addEventListener('click', nextTrack);
        prevBtn.addEventListener('click', prevTrack);
        shuffleBtn.addEventListener('click', toggleShuffle);
        repeatBtn.addEventListener('click', toggleRepeat);

        // Initial load
        updatePlaylistUI();
        if (playlist.length > 0) {
            musicAudio.src = playlist[currentTrackIndex].src;
        }

        // --- CONTRIBUTION LOGIC (Text Only) ---
        const contributeForm = document.getElementById('contribute-form');
        const contributorNameInput = document.getElementById('contributor-name');
        const contributeTextInput = document.getElementById('contribute-text');
        const contributeMessage = document.getElementById('contribute-message');

        contributeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            contributeMessage.textContent = 'Mengirim pesan...';
            contributeMessage.style.color = 'var(--text-secondary)';

            const name = contributorNameInput.value.trim();
            const text = contributeTextInput.value.trim();

            if (!text) {
                contributeMessage.textContent = 'Pesan tidak boleh kosong!';
                contributeMessage.style.color = 'var(--danger)';
                return;
            }

            try {
                const response = await fetch(`${CLOUDFLARE_WORKER_URL}/contribute`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ name, text }),
                });

                if (response.ok) {
                    contributeMessage.textContent = 'Pesan berhasil dikirim!';
                    contributeMessage.style.color = 'var(--success)';
                    contributorNameInput.value = '';
                    contributeTextInput.value = '';
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Gagal mengirim pesan.');
                }
            } catch (error) {
                console.error('Error sending contribution:', error);
                contributeMessage.textContent = `Gagal mengirim pesan: ${error.message}`;
                contributeMessage.style.color = 'var(--danger)';
            }
        });

        // --- LIVE VISITORS LOGIC - REINTEGRATED & EZRA-SPECIFIC ---
        const visitorList = document.getElementById('visitor-list');
        const refreshVisitorsBtn = document.getElementById('refresh-visitors-btn');
        const lastUpdatedTime = document.getElementById('last-updated-time');

        async function fetchLiveVisitors() {
            visitorList.innerHTML = '<li style="text-align: center; color: var(--text-secondary);">Memuat pengunjung...</li>';
            lastUpdatedTime.textContent = 'Memuat...';

            try {
                // Assuming your Cloudflare Worker has a /get_visitors endpoint
                const response = await fetch(`${CLOUDFLARE_WORKER_URL}/get_visitors`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const visitors = await response.json();

                if (visitors && visitors.length > 0) {
                    visitorList.innerHTML = visitors.map(visitor => {
                        const timestamp = new Date(visitor.timestamp).toLocaleString('id-ID', {
                            hour: '2-digit', minute: '2-digit', second: '2-digit',
                            day: '2-digit', month: '2-digit', year: 'numeric'
                        });
                        return `
                            <li>
                                <strong>ID:</strong> <span>${visitor.browserId.substring(0, 10)}...</span><br>
                                <strong>IP:</strong> <span>${visitor.ip || 'N/A'}</span><br>
                                <strong>Waktu:</strong> <span>${timestamp}</span>
                            </li>
                        `;
                    }).join('');
                } else {
                    visitorList.innerHTML = '<li style="text-align: center; color: var(--text-secondary);">Tidak ada pengunjung online.</li>';
                }
                lastUpdatedTime.textContent = new Date().toLocaleTimeString('id-ID');

            } catch (error) {
                console.error('Error fetching live visitors:', error);
                visitorList.innerHTML = '<li style="text-align: center; color: var(--danger);">Gagal memuat pengunjung.</li>';
                lastUpdatedTime.textContent = 'Error';
            }
        }

        refreshVisitorsBtn.addEventListener('click', fetchLiveVisitors);

        // --- PRIVATE USER / EZRA PANEL LOGIC ---
        const privateUserInput = document.getElementById('private-user-input');
        const privateUserSubmitBtn = document.getElementById('private-user-submit');
        const privateUserMessage = document.getElementById('private-user-message');
        const ezraLogoutBtn = document.getElementById('ezra-logout-btn');

        const ezraGalleryContainer = document.getElementById('ezra-gallery-container');
        const ezraGalleryStatus = document.getElementById('ezra-gallery-status');
        const ezraContentForm = document.getElementById('ezra-content-form');
        const editItemIdInput = document.getElementById('edit-item-id');
        const galleryItemTitleInput = document.getElementById('gallery-item-title');
        const galleryItemDescriptionInput = document.getElementById('gallery-item-description');
        const galleryItemMediaInput = document.getElementById('gallery-item-media');
        const submitGalleryItemBtn = document.getElementById('submit-gallery-item');
        const ezraFormStatus = document.getElementById('ezra-form-status');

        privateUserSubmitBtn.addEventListener('click', () => {
            const username = privateUserInput.value.trim().toLowerCase();
            if (username === 'ezra') {
                privateUserPanel.classList.add('hidden');
                ezraPanel.classList.add('active'); // Show Ezra Panel
                showLiveVisitorsBtn.classList.remove('hidden'); // Show Live Visitors button in header
                fabLiveVisitorsBtn.classList.remove('hidden'); // Show Live Visitors FAB
                loadEzraContent(); // Load content when Ezra logs in
                privateUserMessage.textContent = ''; // Clear previous messages
            } else {
                privateUserMessage.textContent = 'Username tidak dikenal.';
            }
        });

        ezraLogoutBtn.addEventListener('click', () => {
            ezraPanel.classList.remove('active'); // Hide Ezra Panel
            liveVisitorsPanel.classList.add('hidden'); // Hide Live Visitors Panel if open
            showLiveVisitorsBtn.classList.add('hidden'); // Hide Live Visitors button in header
            fabLiveVisitorsBtn.classList.add('hidden'); // Hide Live Visitors FAB
            privateUserInput.value = ''; // Clear input
            resetEzraForm(); // Reset form
            ezraGalleryContainer.innerHTML = '<p id="ezra-gallery-status" style="color: var(--text-secondary); text-align: center;">Loading content...</p>'; // Clear gallery
        });

        async function loadEzraContent() {
            ezraGalleryStatus.textContent = 'Memuat konten...';
            ezraGalleryContainer.innerHTML = ''; // Clear existing content

            try {
                const response = await fetch(`${CLOUDFLARE_WORKER_URL}/ezra-content`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const content = await response.json();

                if (content && content.length > 0) {
                    content.sort((a, b) => new Date(b.date) - new Date(a.date)); // Sort by date, newest first
                    content.forEach(item => {
                        const galleryItem = document.createElement('div');
                        galleryItem.className = 'gallery-item';
                        galleryItem.dataset.id = item.id;

                        let mediaHtml = '';
                        if (item.type === 'image') {
                            mediaHtml = `<img src="${item.mediaUrl}" alt="${item.title}">`;
                        } else if (item.type === 'video') {
                            mediaHtml = `<video controls src="${item.mediaUrl}"></video>`;
                        }

                        galleryItem.innerHTML = `
                            ${mediaHtml}
                            <div class="gallery-item-info">
                                <h4 contenteditable="false">${item.title}</h4>
                                <p contenteditable="false">${item.description}</p>
                                <small>${new Date(item.date).toLocaleString('id-ID', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</small>
                            </div>
                            <div class="gallery-item-controls">
                                <button class="edit-item-btn" data-id="${item.id}"><i class="fas fa-edit"></i></button>
                                <button class="delete-item-btn" data-id="${item.id}"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        `;
                        ezraGalleryContainer.appendChild(galleryItem);
                    });

                    // Add event listeners for edit/delete after elements are added
                    document.querySelectorAll('.edit-item-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => editEzraItem(e.currentTarget.dataset.id));
                    });
                    document.querySelectorAll('.delete-item-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => deleteEzraItem(e.currentTarget.dataset.id));
                    });
                    ezraGalleryStatus.textContent = ''; // Clear status if content loaded
                } else {
                    ezraGalleryStatus.textContent = 'Belum ada konten. Tambahkan yang pertama!';
                }
            } catch (error) {
                console.error('Error loading Ezra content:', error);
                ezraGalleryStatus.textContent = `Gagal memuat konten: ${error.message}`;
                ezraGalleryStatus.style.color = 'var(--danger)';
            }
        }

        function resetEzraForm() {
            editItemIdInput.value = '';
            galleryItemTitleInput.value = '';
            galleryItemDescriptionInput.value = '';
            galleryItemMediaInput.value = ''; // Clear file input
            submitGalleryItemBtn.textContent = 'Tambah Konten Baru';
            ezraFormStatus.textContent = '';
        }

        async function editEzraItem(id) {
            ezraFormStatus.textContent = '';
            // Fetch item data or find it in current loaded data
            try {
                const response = await fetch(`${CLOUDFLARE_WORKER_URL}/ezra-content?id=${id}`);
                if (!response.ok) throw new Error('Failed to fetch item for editing');
                const itemToEdit = await response.json();

                editItemIdInput.value = itemToEdit.id;
                galleryItemTitleInput.value = itemToEdit.title;
                galleryItemDescriptionInput.value = itemToEdit.description;
                submitGalleryItemBtn.textContent = 'Update Konten';
                // Media input cannot be pre-filled for security, user has to re-upload if needed
                galleryItemMediaInput.value = '';
                ezraFormStatus.textContent = 'Mode Edit: Upload media baru jika ingin mengganti.';
                ezraFormStatus.style.color = 'var(--text-secondary)';

            } catch (error) {
                console.error('Error preparing edit:', error);
                ezraFormStatus.textContent = `Gagal menyiapkan edit: ${error.message}`;
                ezraFormStatus.style.color = 'var(--danger)';
            }
        }

        async function deleteEzraItem(id) {
            if (!confirm('Apakah Anda yakin ingin menghapus konten ini?')) {
                return;
            }
            ezraFormStatus.textContent = 'Menghapus konten...';
            ezraFormStatus.style.color = 'var(--text-secondary)';

            try {
                const response = await fetch(`${CLOUDFLARE_WORKER_URL}/ezra-content?id=${id}`, {
                    method: 'DELETE',
                });
                if (response.ok) {
                    ezraFormStatus.textContent = 'Konten berhasil dihapus!';
                    ezraFormStatus.style.color = 'var(--success)';
                    loadEzraContent(); // Reload gallery
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Gagal menghapus konten.');
                }
            } catch (error) {
                console.error('Error deleting Ezra item:', error);
                ezraFormStatus.textContent = `Gagal menghapus: ${error.message}`;
                ezraFormStatus.style.color = 'var(--danger)';
            }
        }

        ezraContentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            ezraFormStatus.textContent = 'Mengirim konten...';
            ezraFormStatus.style.color = 'var(--text-secondary)';

            const id = editItemIdInput.value || `item-${Date.now()}`; // Generate new ID if not editing
            const title = galleryItemTitleInput.value.trim();
            const description = galleryItemDescriptionInput.value.trim();
            const mediaFile = galleryItemMediaInput.files[0];
            const isEditing = !!editItemIdInput.value;

            if (!title || !description) {
                ezraFormStatus.textContent = 'Judul dan Deskripsi harus diisi!';
                ezraFormStatus.style.color = 'var(--danger)';
                return;
            }

            // Only require media file for new additions, not for edits without new media
            if (!mediaFile && !isEditing) {
                 ezraFormStatus.textContent = 'Pilih file media untuk konten baru!';
                 ezraFormStatus.style.color = 'var(--danger)';
                 return;
            }

            const formData = new FormData();
            formData.append('id', id);
            formData.append('title', title);
            formData.append('description', description);
            formData.append('date', new Date().toISOString());
            if (mediaFile) {
                formData.append('media', mediaFile);
                formData.append('type', mediaFile.type.startsWith('image/') ? 'image' : 'video');
            } else if (isEditing) {
                 formData.append('noMediaChange', 'true'); // Flag to worker: keep existing media
            }

            try {
                const method = isEditing ? 'PUT' : 'POST';
                const url = `${CLOUDFLARE_WORKER_URL}/ezra-content`; 

                const response = await fetch(url, {
                    method: method,
                    body: formData,
                });

                if (response.ok) {
                    ezraFormStatus.textContent = `Konten berhasil ${isEditing ? 'diperbarui' : 'ditambahkan'}!`;
                    ezraFormStatus.style.color = 'var(--success)';
                    resetEzraForm();
                    loadEzraContent(); // Reload gallery
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `Gagal ${isEditing ? 'memperbarui' : 'menambahkan'} konten.`);
                }
            } catch (error) {
                console.error('Error adding/updating Ezra content:', error);
                ezraFormStatus.textContent = `Gagal ${isEditing ? 'memperbarui' : 'menambahkan'}: ${error.message}`;
                ezraFormStatus.style.color = 'var(--danger)';
            }
        });
    </script>
</body>
</html>
