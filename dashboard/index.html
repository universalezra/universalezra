<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon1.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x321.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x161.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/themes/prism-twilight.min.css">
    <style>
        :root {
            --primary: #8e44ad;
            --accent: #00a8ff;
            --success: #2ecc71;
            --danger: #e74c3c;
            --light: #ecf0f1;
            --dark: #1a1a2e;
            --bg-main: #16213e;
            --bg-panel: rgba(26, 26, 46, 0.9);
            --text-primary: #e0fbfc;
            --text-secondary: #98ded9;
            --border-color: rgba(0, 168, 255, 0.3);
        }

        html[data-theme='light'] {
            --primary: #3498db;
            --accent: #e67e22;
            --bg-main: #ecf0f1;
            --bg-panel: rgba(255, 255, 255, 0.9);
            --text-primary: #2c3e50;
            --text-secondary: #7f8c8d;
            --border-color: rgba(52, 152, 219, 0.4);
        }

        * {
            box-sizing: border-box;
            font-family: 'Courier New', Courier, monospace;
        }

        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: var(--bg-main);
            color: var(--text-primary);
        }

        #interactive-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            background-image: url('January 17, 2025 at 5.10 AM.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            filter: blur(3px);
            -webkit-filter: blur(3px);
        }

        .main-container {
            position: relative;
            z-index: 1;
            width: 100%;
            height: 100%;
            transition: all 0.5s ease-in-out;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            padding: 20px;
        }

        .central-message {
            text-align: center;
            color: var(--text-primary);
            font-size: 1.5em;
            margin-top: 20px;
        }

        .central-message h3 {
            color: var(--accent);
            margin-bottom: 10px;
        }

        .central-message p {
            color: var(--text-primary);
            font-size: 0.8em;
        }

        .ezra-link {
            color: var(--accent);
            text-decoration: none;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .ezra-link:hover {
            color: var(--primary);
        }

        .panel {
            position: fixed;
            background: var(--bg-panel);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            z-index: 1010;
            box-shadow: 0 0 50px rgba(0,0,0,0.6);
            transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55), opacity 0.5s ease;
            display: flex;
            flex-direction: column;
            color: var(--text-primary);
            opacity: 0;
            visibility: hidden;
            padding: 20px;
            border-radius: 15px;
        }

        .panel.active {
            opacity: 1;
            visibility: visible;
        }

        #editor-panel, #live-visitors-panel, #moment-vault-panel {
            top: 0; left: 0; width: 100%; height: 100%;
            transform: translateY(100%);
            padding: 0;
            box-sizing: border-box;
        }

        #editor-panel.active, #live-visitors-panel.active, #moment-vault-panel.active {
            transform: translateY(0);
        }

        #music-panel {
            bottom: 0; left: 0; width: 100%; height: auto;
            max-height: 50vh;
            border-top: 1px solid var(--border-color);
            transform: translateY(100%);
        }

        #music-panel.active {
            transform: translateY(0);
        }

        #contribution-panel {
            top: 0; right: 0; width: 400px; max-width: 90vw; height: 100%;
            transform: translateX(100%);
        }

        #contribution-panel.active {
            transform: translateX(0);
        }

        .panel-close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 5;
            transition: color 0.3s ease;
        }

        .panel-close-btn:hover {
            color: var(--danger);
        }

        .fab-container {
            position: fixed;
            z-index: 1000;
        }

        .fab {
            background: rgba(142, 68, 173, 0.7);
            color: var(--text-primary);
            width: 55px;
            height: 55px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.4rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }

        .fab:hover {
            background: var(--accent);
            transform: scale(1.1);
        }

        #fab-editor { top: 20px; left: 20px; }
        #fab-music {top: 50%; left: 20px; transform: translateY(-50%);}
        #fab-alkitab {top: 20px; right: 20px; }
        #fab-contribution {top: calc(50% + 70px); left: 20px; transform: translateY(-50%);}
        #fab-moment-vault { bottom: 20px; left: 50%; transform: translateX(-50%); }
        #fab-live-visitors { bottom: 90px; left: 50%; transform: translateX(-50%); }

        #editor-panel {
            display: flex;
            flex-direction: column;
        }

        .editor-toolbar {
            display: flex;
            gap: 5px;
            padding: 10px;
            background: rgba(0,0,0,0.5);
            flex-wrap: wrap;
            justify-content: flex-start;
        }

        .editor-toolbar button {
            background: rgba(142, 68, 173, 0.7);
            color: var(--text-primary);
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .editor-toolbar button:hover {
            background: var(--accent);
        }

        .editor-main {
            display: flex;
            flex-grow: 1;
            height: calc(100% - 58px);
        }

        .editor-code-area {
            flex: 1;
            overflow: auto;
            position: relative;
            background: #1e1e1e;
        }

        .editor-code-area pre[class*="language-"] {
            margin: 0;
            padding: 10px;
            min-height: 100%;
        }

        #unified-code-editor {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: transparent;
            color: var(--text-primary);
            border: none;
            resize: none;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            outline: none;
            white-space: pre-wrap;
            word-wrap: break-word;
            tab-size: 4;
            -moz-tab-size: 4;
            caret-color: var(--accent);
            line-height: 1.5;
            z-index: 2;
        }

        #editor-preview {
            flex: 1;
            border: none;
            background: var(--light);
        }

        #video-player-widget {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 999;
            width: 150px;
            height: 150px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0,0,0,0.4);
            border: 2px solid var(--border-color);
        }

        #video-player-widget video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .video-controls {
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            background: rgba(0,0,0,0.5);
            padding: 5px;
            border-radius: 5px;
        }

        .video-controls button {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 1rem;
            cursor: pointer;
        }

        .social-links {
            position: fixed;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 999;
        }

        .social-links a {
            color: var(--text-primary);
            font-size: 1.5rem;
            transition: color 0.3s, transform 0.3s;
        }

        .social-links a:hover {
            color: var(--accent);
            transform: scale(1.2);
        }

        #website-age-display {
            position: fixed;
            bottom: 20px;
            left: 20px;
            font-size: 0.8em;
            color: var(--text-primary);
            z-index: 10;
            background: none;
            padding: 0;
            text-align: center;
            white-space: nowrap;
        }

        .live-visitors-content, .moment-vault-content {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            background: var(--bg-panel);
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
            overflow: hidden;
            padding: 20px;
        }

        #visitor-list ul {
            list-style: none;
            padding: 0;
            margin: 0;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
        }

        #visitor-list li {
            background: rgba(0, 168, 255, 0.1);
            border: 1px solid rgba(0, 168, 255, 0.2);
            border-radius: 10px;
            padding: 15px;
            font-size: 0.9em;
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        #visitor-list li strong {
            color: var(--accent);
        }

        #moment-vault-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
            padding: 10px;
            overflow-y: auto;
        }

        .gallery-item {
            background: rgba(0,0,0,0.2);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: 8px;
            position: relative;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
        }

        .gallery-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.4);
        }

        .gallery-media {
            width: 100%;
            height: 120px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            border-radius: 5px;
            background-color: #333;
        }

        .gallery-media img, .gallery-media video, .gallery-media audio {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .gallery-media .file-icon {
            font-size: 3em;
            color: var(--text-secondary);
        }

        .lightbox {
          display: none;
          position: fixed;
          z-index: 9999;
          padding-top: 60px;
          left: 0;
          top: 0;
          width: 100%;
          height: 100%;
          overflow: auto;
          background-color: rgba(0,0,0,0.9);
        }

        .lightbox-content {
          margin: auto;
          display: block;
          width: 80%;
          max-width: 900px;
          position: relative;
          text-align: center;
        }

        #lightbox-image, #lightbox-video, #lightbox-audio {
          max-width: 100%;
          max-height: 80vh;
          margin: auto;
          display: none;
        }

        .close-btn {
          position: absolute;
          top: 15px;
          right: 35px;
          color: #f1f1f1;
          font-size: 40px;
          font-weight: bold;
          transition: 0.3s;
          cursor: pointer;
        }

        .close-btn:hover,
        .close-btn:focus {
          color: #bbb;
          text-decoration: none;
        }
    </style>
</head>
<body>

    <div id="interactive-bg"></div>
    <div class="main-container">
        <div class="central-message">
            <h3><a href="elvi.html" class="ezra-link">.</a></h3>
        </div>
    </div>

    <div class="panel" id="editor-panel">
        <button class="panel-close-btn" data-panel="editor-panel"><i class="fas fa-times"></i></button>
        <div class="editor-toolbar">
            <button id="editor-run"><i class="fas fa-play"></i> Run</button>
            <button id="editor-save"><i class="fas fa-save"></i> Save</button>
            <button id="editor-load"><i class="fas fa-folder-open"></i> Load</button>
            <button id="editor-new"><i class="fas fa-file"></i> New</button>
            <button id="editor-undo"><i class="fas fa-undo"></i> Undo</button>
            <button id="editor-redo"><i class="fas fa-redo"></i> Redo</button>
        </div>
        <div class="editor-main">
            <div class="editor-code-area">
                <pre class="language-html"><code id="unified-code-editor" contenteditable="true" spellcheck="false"></code></pre>
            </div>
            <div class="editor-preview-area">
                <iframe id="editor-preview"></iframe>
            </div>
        </div>
    </div>

    <div class="panel" id="music-panel">
        <button class="panel-close-btn" data-panel="music-panel"><i class="fas fa-times"></i></button>
        <h4>Now Playing</h4>
        <div id="music-player-content">
            <h5 id="song-title">Select a song</h5>
            <audio id="audio-player" controls loop style="width: 100%;"></audio>
            <div id="playlist" style="max-height: 20vh; overflow-y: auto; margin-top: 10px;"></div>
        </div>
    </div>

    <div class="panel" id="contribution-panel">
        <button class="panel-close-btn" data-panel="contribution-panel"><i class="fas fa-times"></i></button>
        <div id="contribution-content">
            <h3>Leave a Message</h3>
            <div id="contribution-display"></div>
            <form id="contribution-form">
                <textarea id="contribution-text" placeholder="Your message" required></textarea>
                <div style="display:flex; justify-content:flex-end; margin-top:10px;"> 
                    <button type="submit" class="fab"><i class="fas fa-paper-plane"></i></button>
                </div>
                <p id="contribution-status"></p>
            </form>
        </div>
    </div>

    <div class="panel" id="moment-vault-panel">
        <button class="panel-close-btn" data-panel="moment-vault-panel"><i class="fas fa-times"></i></button>
        <div class="moment-vault-content">
            <h3>Gallery</h3>
            <div id="moment-vault-gallery-container">
                <div id="moment-vault-gallery"></div>
            </div>
            <form id="moment-upload-form">
                <input type="text" id="moment-title" placeholder="Title" required>
                <textarea id="moment-description" placeholder="Describe" rows="3"></textarea>
                <input type="file" id="moment-file" accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.txt" required>
                <button type="submit">Upload</button>
                <p id="moment-upload-status"></p>
            </form>
        </div>
    </div>
    
    <div class="panel" id="live-visitors-panel">
        <button class="panel-close-btn" data-panel="live-visitors-panel"><i class="fas fa-times"></i></button>
        <div class="live-visitors-content">
            <h3>Live Visitors</h3>
            <div id="mv-live-visitors-list-container">
                <ul id="visitor-list"></ul>
            </div>
            <div class="visitor-status">updated: <span id="last-updated-time">N/A</span></div>
        </div>
    </div>

    <div class="fab-container" id="fab-editor"><button class="fab" data-panel="editor-panel" title="Code Editor"><i class="fas fa-code"></i></button></div>
    <div class="fab-container" id="fab-music"><button class="fab" data-panel="music-panel" title="Music Player"><i class="fas fa-music"></i></button></div>
    <div class="fab-container" id="fab-contribution"><button class="fab" data-panel="contribution-panel" title="Leave a Message"><i class="fas fa-feather-alt"></i></button></div>
    <div class="fab-container" id="fab-alkitab"><a href="https://alkitab.me/in-tb/Matius/5/13" target="_blank" class="fab" title="Alkitab"><i class="fas fa-book"></i></a></div>
    <div class="fab-container" id="fab-live-visitors" style="display: none;"><button class="fab" data-panel="live-visitors-panel" title="Live Visitors"><i class="fas fa-eye"></i></button></div>
    <div class="fab-container" id="fab-moment-vault"><button class="fab" data-panel="moment-vault-panel" title="Moment Vault"><i class="fas fa-archive"></i></button></div>

    <div id="video-player-widget">
        <video id="widget-video" loop src="video.mp4"></video>
        <div class="video-controls">
            <button id="video-play-pause"><i class="fas fa-play"></i></button>
            <button id="video-mute"><i class="fas fa-volume-up"></i></button>
        </div>
    </div>
    <div class="social-links">
        <a href="https://wa.me/6283844959380" target="_blank" title="WhatsApp"><i class="fab fa-whatsapp"></i></a>
        <a href="https://instagram.com/I_dont_care_now" target="_blank" title="Instagram"><i class="fab fa-instagram"></i></a>
    </div>
    <div id="website-age-display"></div>

    <div id="lightbox" class="lightbox">
      <span class="close-btn">&times;</span>
      <div class="lightbox-content">
        <img id="lightbox-image" src="" alt="">
        <video id="lightbox-video" src="" controls></video>
        <audio id="lightbox-audio" src="" controls></audio>
        <div id="lightbox-document"></div>
      </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/components/prism-clike.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/components/prism-css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/components/prism-markup.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Inisialisasi semua fungsi di sini
            initPanelControls();
            initVideoPlayer();
            initMusicPlayer();
            initEditor();
            initVisitorsPanel();
            initWebsiteAgeDisplay();
            trackVisitor();
            document.getElementById('contribution-form').addEventListener('submit', uploadContribution);
            document.getElementById('moment-upload-form').addEventListener('submit', uploadMoment);

            // Cek layout desktop
            checkLayout();
            window.addEventListener('resize', checkLayout);
        });

        // --- Variabel Konstan ---
        const CONTRIBUTIONS_WORKER_URL = 'https://contributions-workerjs.ezvvel.workers.dev/';
        const MOMENT_VAULT_WORKER_URL = 'https://moment-vault-worker-url.universalezra.workers.dev';
        const GITHUB_REPO_OWNER = 'universalezra';
        const GITHUB_REPO_NAME = 'universalezra';
        const GITHUB_TOKEN_WORKER_URL = 'https://github-token-worker-url.universalezra.workers.dev';
        const LIVE_VISITORS_WORKER_URL = 'https://live-visitors.ezvvel.workers.dev/';
        const LIVE_VISITORS_PASSWORD = "v";
        let isEzraLoggedIn = false;
        let liveVisitorRefreshInterval;
        let currentGalleryItems = [];
        const REFRESH_INTERVAL_MS = 5000;

        // --- Fungsi Utilitas ---
        async function fetchWithTimeout(resource, options = {}) {
            const { timeout = 8000 } = options;
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), timeout);
            try {
                const response = await fetch(resource, { ...options, signal: controller.signal });
                clearTimeout(id);
                return response;
            } catch (error) {
                clearTimeout(id);
                throw error;
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.classList.add('hide');
                notification.addEventListener('transitionend', () => {
                    notification.remove();
                });
            }, 3000);
        }

        function getBrowserId() {
            let browserId = localStorage.getItem('unique_browser_id');
            if (!browserId) {
                browserId = 'browser_' + Math.random().toString(36).substr(2, 9) + Date.now();
                localStorage.setItem('unique_browser_id', browserId);
            }
            return browserId;
        }

        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        // --- Inisialisasi Panel dan Kontrol ---
        function initPanelControls() {
            document.querySelectorAll('[data-panel]').forEach(button => {
                button.addEventListener('click', () => {
                    const panelId = button.getAttribute('data-panel');
                    const panel = document.getElementById(panelId);
                    const isActive = panel.classList.contains('active');

                    document.querySelectorAll('.panel.active').forEach(otherPanel => {
                        otherPanel.classList.remove('active');
                    });

                    if (!isActive) {
                        panel.classList.add('active');
                        if (panelId === 'contribution-panel') fetchContributions();
                        if (panelId === 'moment-vault-panel') fetchMomentVaultGallery();
                    }
                });
            });

            document.querySelectorAll('.panel-close-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const panel = e.target.closest('.panel');
                    if (panel) {
                        panel.classList.remove('active');
                    }
                });
            });
        }

        // --- Video Player ---
        function initVideoPlayer() {
            const video = document.getElementById('widget-video');
            const playPauseBtn = document.getElementById('video-play-pause');
            const muteBtn = document.getElementById('video-mute');

            playPauseBtn.addEventListener('click', () => {
                if (video.paused) {
                    video.play();
                    playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
                } else {
                    video.pause();
                    playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                }
            });

            muteBtn.addEventListener('click', () => {
                video.muted = !video.muted;
                muteBtn.innerHTML = video.muted ? '<i class="fas fa-volume-mute"></i>' : '<i class="fas fa-volume-up"></i>';
            });
        }

        // --- Music Player ---
        function initMusicPlayer() {
            const player = document.getElementById('audio-player');
            const playlistEl = document.getElementById('playlist');
            const songTitleEl = document.getElementById('song-title');
            const songs = [
                { name: "Life Goes On", url: "Life-Goes-On.mp3" },
                { name: "Where We Are", url: "Where-We-Are.mp3" },
                { name: "Sekuat Hatimu", url: "Sekuat Hatimu.mp3" },
            ];
            
            songs.forEach((song) => {
                const item = document.createElement('div');
                item.textContent = song.name;
                item.className = 'playlist-item';
                item.onclick = () => {
                    player.src = song.url;
                    songTitleEl.textContent = song.name;
                    player.play();
                    showNotification(`Now playing: ${song.name}`, 'info');
                };
                playlistEl.appendChild(item);
            });
        }
        
        // --- Code Editor ---
        function initEditor() {
            const codeEditor = document.getElementById('unified-code-editor');
            const previewFrame = document.getElementById('editor-preview');
            const runBtn = document.getElementById('editor-run');
            const saveBtn = document.getElementById('editor-save');
            const loadBtn = document.getElementById('editor-load');
            const newBtn = document.getElementById('editor-new');
            const undoBtn = document.getElementById('editor-undo');
            const redoBtn = document.getElementById('editor-redo');

            let history = [''];
            let historyPointer = 0;

            const runCode = () => {
                const fullCode = codeEditor.textContent;
                const source = `<!DOCTYPE html><html><head><style>${fullCode.match(/<style>([\s\S]*?)<\/style>/i)?.[1] || ''}</style></head><body>${fullCode.match(/<body>([\s\S]*?)<\/body>/i)?.[1] || fullCode}<script>${fullCode.match(/<script>([\s\S]*?)<\/script>/i)?.[1] || ''}<\/script></body></html>`;
                previewFrame.srcdoc = source;
            };

            const updateHistory = () => {
                const currentCode = codeEditor.textContent;
                if (currentCode !== history[historyPointer]) {
                    if (historyPointer < history.length - 1) {
                        history = history.slice(0, historyPointer + 1);
                    }
                    history.push(currentCode);
                    historyPointer = history.length - 1;
                }
                Prism.highlightElement(codeEditor);
            };

            const saveCode = () => {
                localStorage.setItem('unified_editor_code', codeEditor.textContent);
                showNotification('Code saved to local storage.', 'success');
            };

            const loadCode = () => {
                codeEditor.textContent = localStorage.getItem('unified_editor_code') || `<!DOCTYPE html>
<html>
<head>
    <title>My trial</title>
    <style>
        body {
            font-family: sans-serif;
            background-color: #000000;
            color: #259;
            text-align: center;
            padding-top: 50px;
        }
        h1 {
            color: var(--primary);
        }
    </style>
</head>
<body>
    <h1>Hello Editor</h1>
    <p id="message">Code Here</p>
    <script>
        document.getElementById('message').onclick = function() {
            console.log('Paragraph clicked!');
        };
    </script>
</body>
</html>`;
                runCode();
                history = [codeEditor.textContent];
                historyPointer = 0;
                Prism.highlightElement(codeEditor);
            };
            
            runBtn.addEventListener('click', runCode);
            saveBtn.addEventListener('click', saveCode);
            loadBtn.addEventListener('click', loadCode);
            // newBtn, undo, redo juga akan diimplementasikan di sini
            
            codeEditor.addEventListener('input', updateHistory);
            loadCode();
        }

        // --- Contributions ---
        async function fetchContributions() {
            const display = document.getElementById('contribution-display');
            display.innerHTML = `<p>Loading...</p>`;
            try {
                const response = await fetchWithTimeout(CONTRIBUTIONS_WORKER_URL);
                const contributions = await response.json();
                if (contributions && contributions.length > 0) {
                    display.innerHTML = contributions.reverse().map(c => {
                        return `<div class="contribution-item"><p>${c.text}</p><small>${new Date(c.timestamp).toLocaleString()}</small></div>`;
                    }).join('');
                } else {
                    display.innerHTML = `<p>Be the first to leave a message!</p>`;
                }
            } catch (e) {
                showNotification('Could not load messages.', 'danger');
            }
        }

        async function uploadContribution(e) {
            e.preventDefault();
            const statusEl = document.getElementById('contribution-status');
            statusEl.textContent = 'Uploading...';
            const text = document.getElementById('contribution-text').value;

            try {
                const response = await fetchWithTimeout(CONTRIBUTIONS_WORKER_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text })
                });
                if (!response.ok) throw new Error('Upload failed');
                statusEl.textContent = 'Message sent. Thank you.';
                e.target.reset();
                showNotification('Message successfully sent!', 'success');
                fetchContributions();
            } catch (err) {
                statusEl.textContent = `Error: ${err.message}`;
                showNotification('Failed to send message.', 'danger');
            }
        }
        
        // --- Moment Vault (Galeri) ---
        function openLightbox(item) {
            const lightbox = document.getElementById('lightbox');
            const image = document.getElementById('lightbox-image');
            const video = document.getElementById('lightbox-video');
            const audio = document.getElementById('lightbox-audio');
            const documentContainer = document.getElementById('lightbox-document');

            image.style.display = 'none';
            video.style.display = 'none';
            audio.style.display = 'none';
            documentContainer.style.display = 'none';
            documentContainer.innerHTML = '';

            const fileType = item.fileType || '';
            if (fileType.startsWith('image/')) {
                image.src = item.fileUrl;
                image.style.display = 'block';
            } else if (fileType.startsWith('video/')) {
                video.src = item.fileUrl;
                video.style.display = 'block';
            } else if (fileType.startsWith('audio/')) {
                audio.src = item.fileUrl;
                audio.style.display = 'block';
            } else {
                documentContainer.innerHTML = `<iframe src="${item.fileUrl}" style="width:100%;height:80vh;border:none;"></iframe>`;
                documentContainer.style.display = 'block';
            }

            lightbox.style.display = 'block';
            document.querySelector('.close-btn').onclick = () => lightbox.style.display = 'none';
        }

        async function fetchMomentVaultGallery() {
            const galleryContainer = document.getElementById('moment-vault-gallery');
            galleryContainer.innerHTML = '<p style="text-align: center;">Loading...</p>';
            try {
                const response = await fetchWithTimeout(MOMENT_VAULT_WORKER_URL + '?get_gallery=true');
                const items = await response.json();
                currentGalleryItems = items;

                if (items && items.length > 0) {
                    items.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    galleryContainer.innerHTML = items.map(item => {
                        let mediaHTML = '';
                        const fileType = item.fileType || '';
                        if (fileType.startsWith('image/')) {
                            mediaHTML = `<img src="${item.fileUrl}" alt="${item.title}">`;
                        } else if (fileType.startsWith('video/')) {
                            mediaHTML = `<video src="${item.fileUrl}" controls muted></video>`;
                        } else if (fileType.startsWith('audio/')) {
                            mediaHTML = `<audio src="${item.fileUrl}" controls></audio>`;
                        } else {
                            mediaHTML = `<div class="file-icon"><i class="fas fa-file"></i></div>`;
                        }
                        
                        return `
                            <div class="gallery-item" data-id="${item.id}">
                                <div class="gallery-media">${mediaHTML}</div>
                                <h5 class="gallery-title">${item.title}</h5>
                                <p class="gallery-description">${item.description}</p>
                                <button class="delete-btn" data-id="${item.id}" style="position: absolute; top: 5px; right: 5px; background: none; border: none; color: var(--danger); font-size: 1.2rem; cursor: pointer;"><i class="fas fa-times-circle"></i></button>
                            </div>
                        `;
                    }).join('');

                    galleryContainer.querySelectorAll('.gallery-item').forEach(itemEl => {
                        itemEl.addEventListener('click', (e) => {
                            if (!e.target.closest('.delete-btn')) {
                                const itemId = itemEl.dataset.id;
                                const item = currentGalleryItems.find(i => i.id === itemId);
                                if (item) openLightbox(item);
                            }
                        });
                    });

                    galleryContainer.querySelectorAll('.delete-btn').forEach(deleteBtn => {
                        deleteBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            deleteMoment(e.target.closest('.delete-btn').dataset.id);
                        });
                    });

                } else {
                    galleryContainer.innerHTML = '<p style="text-align: center;">No moments yet.</p>';
                }
            } catch (error) {
                showNotification('Failed to load gallery items.', 'danger');
            }
        }

        async function uploadMoment(e) {
            e.preventDefault();
            const form = e.target;
            const title = form.elements['moment-title'].value;
            const description = form.elements['moment-description'].value;
            const file = form.elements['moment-file'].files[0];
            const statusEl = document.getElementById('moment-upload-status');

            if (!file) {
                showNotification('Please select a file.', 'danger');
                return;
            }

            statusEl.textContent = 'Uploading...';

            try {
                const base64Content = await readFileAsBase64(file);
                const response = await fetchWithTimeout(MOMENT_VAULT_WORKER_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: title,
                        description: description,
                        filename: file.name,
                        filetype: file.type,
                        filecontent: base64Content
                    })
                });

                if (!response.ok) throw new Error('Upload failed.');

                showNotification('Upload successful!', 'success');
                form.reset();
                fetchMomentVaultGallery();
            } catch (error) {
                showNotification(`Upload failed: ${error.message}`, 'danger');
            } finally {
                statusEl.textContent = '';
            }
        }

        async function deleteMoment(itemId) {
            if (!confirm('Are you sure you want to delete this moment?')) return;
            showNotification('Deleting...', 'info');

            try {
                const response = await fetchWithTimeout(MOMENT_VAULT_WORKER_URL, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ moment_id: itemId })
                });

                if (!response.ok) throw new Error('Deletion failed.');

                showNotification('Item deleted successfully.', 'success');
                fetchMomentVaultGallery();
            } catch (error) {
                showNotification(`Failed to delete item: ${error.message}`, 'danger');
            }
        }
        
        // --- Live Visitors ---
        async function fetchLiveVisitors() {
            const visitorList = document.getElementById('visitor-list');
            const lastUpdatedTime = document.getElementById('last-updated-time');

            try {
                const response = await fetchWithTimeout(LIVE_VISITORS_WORKER_URL + '?get_visitors=true');
                const visitors = await response.json();

                if (visitors && visitors.length > 0) {
                    visitorList.innerHTML = visitors.map(visitor => {
                        const timestamp = new Date(visitor.timestamp).toLocaleString('id-ID');
                        return `<li><strong>ID:</strong> ${visitor.browserId.substring(0, 10)}<br><strong>IP:</strong> ${visitor.ip || 'N/A'}<br><strong>Waktu:</strong> ${timestamp}<br><strong>Negara:</strong> ${visitor.country || 'N/A'}<br><strong>Perangkat:</strong> ${visitor.device || 'N/A'}</li>`;
                    }).join('');
                } else {
                    visitorList.innerHTML = '<li>No visitors online.</li>';
                }
                lastUpdatedTime.textContent = new Date().toLocaleTimeString('id-ID');
            } catch (error) {
                console.error('Error fetching live visitors:', error);
                visitorList.innerHTML = '<li>Failed to load visitors.</li>';
            }
        }

        async function trackVisitor() {
            try {
                const browserId = getBrowserId();
                let ipAddress = 'unknown';
                
                const data = {
                    browserId: browserId,
                    ip: ipAddress, // Asumsi ini diisi oleh worker
                    userAgent: navigator.userAgent,
                    timestamp: new Date().toISOString()
                };
                fetch(LIVE_VISITORS_WORKER_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                }).catch(e => console.error("Error tracking visitor:", e));
            } catch(e) {
                console.error('Error in trackVisitor:', e);
            }
        }

        function initVisitorsPanel() {
            const fab = document.getElementById('fab-live-visitors');
            fab.style.display = 'block'; // Tampilkan FAB
            fab.addEventListener('click', () => {
                const panel = document.getElementById('live-visitors-panel');
                if (!isEzraLoggedIn) {
                    const password = prompt("Enter password:");
                    if (password === LIVE_VISITORS_PASSWORD) {
                        isEzraLoggedIn = true;
                        panel.classList.add('active');
                        fetchLiveVisitors();
                        liveVisitorRefreshInterval = setInterval(fetchLiveVisitors, REFRESH_INTERVAL_MS);
                    } else {
                        showNotification("Incorrect password!", 'danger');
                    }
                } else {
                    const isActive = panel.classList.contains('active');
                    if (isActive) {
                        panel.classList.remove('active');
                        clearInterval(liveVisitorRefreshInterval);
                    } else {
                        panel.classList.add('active');
                        fetchLiveVisitors();
                        liveVisitorRefreshInterval = setInterval(fetchLiveVisitors, REFRESH_INTERVAL_MS);
                    }
                }
            });
        }
        
        // --- Tampilan Usia Website ---
        function initWebsiteAgeDisplay() {
            const websiteAgeEl = document.getElementById('website-age-display');
            const startDate = new Date('2024-01-01T00:00:00Z'); // Tanggal mulai website
            
            setInterval(() => {
                const now = new Date();
                const diff = now.getTime() - startDate.getTime();
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                
                websiteAgeEl.innerHTML = `Website age: ${days} days, ${hours} hours, ${minutes} minutes, ${seconds} seconds`;
            }, 1000);
        }

        // --- Layout Desktop/Mobile ---
        function checkLayout() {
            if (window.innerWidth > 1024) {
                document.body.classList.add('desktop-layout');
            } else {
                document.body.classList.remove('desktop-layout');
            }
        }
    </script>
</body>
</html>
